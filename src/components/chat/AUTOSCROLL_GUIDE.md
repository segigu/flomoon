# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª—É –≤ ChatManager

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç –Ω—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å –æ–±–ª–∞—Å—Ç—å –≤–Ω–∏–∑, —á—Ç–æ–±—ã –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –í –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (ModernNastiaApp)

ChatManager –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **`window.scrollTo()`** –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å viewport.

```typescript
// useChatScroll.ts - –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
window.scrollTo({
  top: document.documentElement.scrollHeight - window.innerHeight + 80,
  behavior: 'smooth',
});
```

**80px** - –æ—Ç—Å—Ç—É–ø –¥–ª—è tab bar –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞.

### –í –ø–µ—Å–æ—á–Ω–∏—Ü–µ (—Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞)

ChatManager –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç–æ–π. –ù—É–∂–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å **–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**, –∞ –Ω–µ window.

## –†–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–µ—Å–æ—á–Ω–∏—Ü—ã

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```jsx
<div style={{ height: '400px', overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
  <div ref={chatScrollRef} style={{ flex: 1, overflow: 'auto' }}>
    <ChatManager onMessagesChange={handleMessagesChange} />
  </div>
</div>
```

**–í–∞–∂–Ω–æ:**
- –í–Ω–µ—à–Ω–∏–π div –∏–º–µ–µ—Ç **—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É** (`height: 400px`)
- –í–Ω–µ—à–Ω–∏–π div –∏–º–µ–µ—Ç `overflow: hidden` (—Å–∫—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ)
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π div –∏–º–µ–µ—Ç `flex: 1` (–∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ)
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π div –∏–º–µ–µ—Ç `overflow: auto` (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç scrollbar –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏)

### 2. Callback onMessagesChange

ChatManager —É–≤–µ–¥–æ–º–ª—è–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —á–∞—Ç–µ:

```typescript
// ChatManager.tsx
useEffect(() => {
  if (onMessagesChange) {
    onMessagesChange();
  }
}, [chat.messages.length, chat.typingAuthor, onMessagesChange]);
```

**–í–∞–∂–Ω–æ:** Callback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
- ‚úÖ –ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`messages.length` –∏–∑–º–µ–Ω–∏–ª—Å—è)
- ‚úÖ –ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è/–∏—Å—á–µ–∑–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ (`typingAuthor` –∏–∑–º–µ–Ω–∏–ª—Å—è)

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–∫—Ä–æ–ª–ª —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **–î–û –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞**, –ø–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç—Ä–∏ —Ç–æ—á–∫–∏ "..."

### 3. –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ

```typescript
const handleMessagesChange = useCallback(() => {
  // –¢—Ä–æ–π–Ω–æ–π requestAnimationFrame –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (chatScrollRef.current) {
          // –ü—Ä–æ—Å—Ç–æ —Å–∫—Ä–æ–ª–ª–∏–º –¥–æ –∫–æ–Ω—Ü–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          // Tab bar —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ paddingBottom –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          chatScrollRef.current.scrollTo({
            top: chatScrollRef.current.scrollHeight,
            behavior: 'smooth',
          });
          console.log(
            '[Sandbox] Auto-scroll to:',
            chatScrollRef.current.scrollHeight,
            'Tab Bar:',
            showTabBar ? 'ON (padding-bottom applied)' : 'OFF'
          );
        }
      });
    });
  });
}, [showTabBar]);
```

**–í–∞–∂–Ω–æ:** –ü–µ—Å–æ—á–Ω–∏—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `paddingBottom` –Ω–∞ –ö–û–ù–¢–ï–ù–¢–ï –≤–Ω—É—Ç—Ä–∏ scrollable –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (`chatScrollRef`). ChatManager –æ–±—ë—Ä–Ω—É—Ç –≤ `<div style={{ paddingBottom: showTabBar ? '80px' : '0px' }}>`, —á—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–æ—Å—å –∑–∞ fixed tab bar. –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä–æ–ª–ª–∏—Ç –¥–æ `scrollHeight` –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.

**–ü–æ—á–µ–º—É —Ç—Ä–æ–π–Ω–æ–π RAF?**
1. **1-–π RAF**: React –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π DOM
2. **2-–π RAF**: –ë—Ä–∞—É–∑–µ—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É DOM
3. **3-–π RAF**: DOM –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã ‚Üí `scrollHeight` –∞–∫—Ç—É–∞–ª–µ–Ω ‚Üí —Å–∫—Ä–æ–ª–ª–∏–º

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç—Å—Ç—É–ø–∞ –¥–ª—è –ø–ª–∞–≤–∞—é—â–µ–≥–æ –º–µ–Ω—é

–ï—Å–ª–∏ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ –µ—Å—Ç—å –ø–ª–∞–≤–∞—é—â–µ–µ –º–µ–Ω—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, tab bar), –Ω—É–∂–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å **—á—É—Ç—å –≤—ã—à–µ**, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–æ—Å—å –∑–∞ –º–µ–Ω—é.

### –î–ª—è window.scrollTo (–æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)

```typescript
const TAB_BAR_HEIGHT = 80; // –≤—ã—Å–æ—Ç–∞ tab bar

window.scrollTo({
  top: document.documentElement.scrollHeight - window.innerHeight + TAB_BAR_HEIGHT,
  behavior: 'smooth',
});
```

### –î–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–µ—Å–æ—á–Ω–∏—Ü–∞)

```typescript
const BOTTOM_MENU_HEIGHT = 60; // –≤—ã—Å–æ—Ç–∞ –º–µ–Ω—é

chatScrollRef.current.scrollTo({
  top: chatScrollRef.current.scrollHeight - chatScrollRef.current.clientHeight + BOTTOM_MENU_HEIGHT,
  behavior: 'smooth',
});
```

–ò–ª–∏ –¥–æ–±–∞–≤—å `padding-bottom` –∫ ChatManager:

```css
.historyChatMessages {
  padding-bottom: 60px; /* –≤—ã—Å–æ—Ç–∞ –º–µ–Ω—é */
}
```

## –û—Ç–ª–∞–¥–∫–∞

### –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏

–í –ø–µ—Å–æ—á–Ω–∏—Ü–µ –≤–∫–ª—é—á–µ–Ω—ã –ª–æ–≥–∏ –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞:

```typescript
console.log('[Sandbox] Auto-scroll to:', chatScrollRef.current.scrollHeight);
```

–í `useChatScroll.ts` —Ç–∞–∫–∂–µ –µ—Å—Ç—å –ª–æ–≥–∏:

```typescript
console.log('[useChatScroll] Phase: dialogue, scrolling to BOTTOM');
console.log('[useChatScroll] Scrolling to MOON, targetTop:', targetTop);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ scrollHeight

–í DevTools:

```javascript
// –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è
chatScrollRef.current.scrollTop

// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
chatScrollRef.current.scrollHeight

// –í—ã—Å–æ—Ç–∞ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
chatScrollRef.current.clientHeight

// –ü—Ä–æ–≤–µ—Ä–∫–∞: scrollTop + clientHeight ‚âà scrollHeight ‚Üí —Å–∫—Ä–æ–ª–ª–µ–Ω–æ –¥–æ –∫–æ–Ω—Ü–∞
```

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### ‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–±—ã–ª–∏ –∑–∞–¥–∞—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É.

```jsx
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
<div style={{ minHeight: '400px' }}> // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞—Å—Ç—ë—Ç!

// –ü–†–ê–í–ò–õ–¨–ù–û
<div style={{ height: '400px' }}> // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞
```

### ‚ùå –°–∫—Ä–æ–ª–ª –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ã–∑—ã–≤–∞–µ—Ç–µ `scrollTo()` —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `addMessage()`, –Ω–æ DOM –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è.

```typescript
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
chatRef.current?.addMessage(message);
chatScrollRef.current?.scrollTo({ top: scrollHeight }); // scrollHeight —Å—Ç–∞—Ä—ã–π!

// –ü–†–ê–í–ò–õ–¨–ù–û
chatRef.current?.addMessage(message);
// ChatManager –≤—ã–∑–æ–≤–µ—Ç onMessagesChange –ü–û–°–õ–ï —Ä–µ–Ω–¥–µ—Ä–∞
```

### ‚ùå –°–∫—Ä–æ–ª–ª–∏—Ç–µ –Ω–µ —Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∫—Ä–æ–ª–ª–∏—Ç–µ –≤–Ω–µ—à–Ω–∏–π div –≤–º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ.

```jsx
<div ref={wrongRef}> // ‚ùå —ç—Ç–æ—Ç –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è (overflow: hidden)
  <div ref={chatScrollRef}> // ‚úÖ —ç—Ç–æ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è (overflow: auto)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í –ø–µ—Å–æ—á–Ω–∏—Ü–µ

1. –û—Ç–∫—Ä–æ–π `http://localhost:3000/?sandbox`
2. –ù–∞–∂–º–∏ **üé¨ –°–∏–º—É–ª—è—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø–ª–∞–Ω–µ—Ç**
3. –°–º–æ—Ç—Ä–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –ª–æ–≥–∏ `[Sandbox] Auto-scroll to: ...`
4. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è –≤–Ω–∏–∑ –ø–ª–∞–≤–Ω–æ
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Tab Bar:**
   - –í–∫–ª—é—á–∏ Tab Bar –∫–Ω–æ–ø–∫–æ–π "Tab Bar: ON"
   - –ù–∞–∂–º–∏ **üìñ –°–∏–º—É–ª—è—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏**
   - –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–µ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª—å—é
   - –í—ã–∫–ª—é—á–∏ Tab Bar –∏ –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–∫—Ä–æ–ª–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—Ç—Å—Ç—É–ø–∞

### –í –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

1. –û—Ç–∫—Ä–æ–π `http://localhost:3000/`
2. –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **–£–∑–Ω–∞–π —Å–µ–±—è**
3. –ù–∞–∂–º–∏ **–ù–∞—á–∞—Ç—å**
4. –°–º–æ—Ç—Ä–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –ª–æ–≥–∏ `[useChatScroll] ...`
5. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è –≤–Ω–∏–∑

## –†–µ–∑—é–º–µ

| –ö–æ–Ω—Ç–µ–∫—Å—Ç | –ú–µ—Ç–æ–¥ —Å–∫—Ä–æ–ª–ª–∞ | Ref | –û—Ç—Å—Ç—É–ø –¥–ª—è –º–µ–Ω—é |
|----------|---------------|-----|-----------------|
| –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | `window.scrollTo()` | –ù–µ –Ω—É–∂–µ–Ω | `+ 80` –≤ `top` |
| –ü–µ—Å–æ—á–Ω–∏—Ü–∞ | `containerRef.scrollTo()` | `chatScrollRef` | `padding-bottom` –∏–ª–∏ `+ 60` –≤ `top` |

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:** –°–∫—Ä–æ–ª–ª–∏—Ç–µ —Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç, —É –∫–æ—Ç–æ—Ä–æ–≥–æ `overflow: auto` –∏–ª–∏ `overflow: scroll`.
