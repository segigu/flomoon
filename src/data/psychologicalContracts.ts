/**
 * Психологические контракты — базовые внутренние конфликты личности
 * с привязкой к астрологическим показателям, типичным ловушкам и сценариям
 */

export interface PsychologicalTrap {
  name: string;
  description: string;
}

export interface ContractScenario {
  setting: string; // Обстановка/локация
  situation: string; // Начальная ситуация
  symbolism: string; // Что символизирует сценарий
}

export interface PsychologicalContract {
  id: string;
  question: string; // Основной вопрос контракта
  theme: string; // Тема (эмоции, идентичность, отношения и т.д.)
  astroIndicators: string[]; // Астрологические показатели
  commonTraps: PsychologicalTrap[]; // Типичные ловушки
  scenarios: ContractScenario[]; // Подходящие сценарии
  choicePoints: string[]; // Ключевые точки выбора
}

export const PSYCHOLOGICAL_CONTRACTS: PsychologicalContract[] = [
  {
    id: 'trust-vs-reason',
    question: 'Могу ли я доверять своим чувствам, когда разум говорит иное?',
    theme: 'Эмоции и логика',
    astroIndicators: [
      'Луна в конфликте с Меркурием',
      'Луна в квадрате/оппозиции с Сатурном',
      'Меркурий в водном знаке vs Луна в воздушном',
    ],
    commonTraps: [
      {
        name: 'Рационализация чувств',
        description: 'Попытка объяснить эмоции логикой, вместо того чтобы их прожить',
      },
      {
        name: 'Игнорирование интуиции',
        description: 'Отказ от внутреннего знания в пользу "разумных" аргументов',
      },
      {
        name: 'Эмоциональное онемение',
        description: 'Выбор не чувствовать, чтобы не ошибиться',
      },
    ],
    scenarios: [
      {
        setting: 'Лаборатория или библиотека ночью',
        situation: 'Ты исследуешь что-то важное, но все данные противоречат твоему внутреннему ощущению',
        symbolism: 'Конфликт между системой знаний и внутренним знанием',
      },
      {
        setting: 'Больничный коридор в сумерках',
        situation: 'Ты должна принять решение о лечении, но интуиция говорит одно, а врачи — другое',
        symbolism: 'Доверие к внешнему авторитету vs внутреннему голосу',
      },
      {
        setting: 'Пустой офис поздно вечером',
        situation: 'Ты нашла документ, который логически верен, но чувствуешь: что-то не так',
        symbolism: 'Рациональная правда vs эмоциональная правда',
      },
    ],
    choicePoints: [
      'Поверить цифрам или ощущению тревоги?',
      'Следовать плану или импульсу?',
      'Объяснить себе чувство или позволить ему быть?',
    ],
  },
  {
    id: 'desire-vs-duty',
    question: 'Имею ли я право на свои желания, если они идут вразрез с привычным?',
    theme: 'Желания и долг',
    astroIndicators: [
      'Венера в напряжённых аспектах с Сатурном',
      'Луна в конфликте с Сатурном',
      'Солнце в квадрате к Сатурну',
    ],
    commonTraps: [
      {
        name: 'Самопожертвование',
        description: 'Отказ от желаний под видом заботы о других',
      },
      {
        name: 'Откладывание жизни',
        description: 'Обещание себе "потом, когда закончу обязательства"',
      },
      {
        name: 'Чувство вины за удовольствие',
        description: 'Наказание себя за любое проявление эгоизма',
      },
    ],
    scenarios: [
      {
        setting: 'Вокзал на рассвете',
        situation: 'У тебя билет на поезд в город мечты, но телефон разрывается от звонков близких',
        symbolism: 'Побег к себе vs удержание обязательствами',
      },
      {
        setting: 'Закрытый магазин игрушек ночью',
        situation: 'Ты стоишь перед витриной с вещью, которую хотела в детстве, но так и не получила',
        symbolism: 'Детские желания vs взрослая ответственность',
      },
      {
        setting: 'Чердак родительского дома',
        situation: 'Ты нашла свои старые мечты в коробке и должна решить: выбросить или вспомнить?',
        symbolism: 'Похороненные желания и второй шанс',
      },
    ],
    choicePoints: [
      'Остаться или уехать?',
      'Взять желаемое или отказаться?',
      'Вспомнить мечту или забыть навсегда?',
    ],
  },
  {
    id: 'vulnerability-vs-control',
    question: 'Смогу ли я позволить себе быть уязвимой, не потеряв контроль?',
    theme: 'Уязвимость и контроль',
    astroIndicators: [
      'Плутон в напряжении к Луне',
      'Сатурн в напряжении к Луне/Венере',
      'Скорпион на ASC или много планет в 8-м доме',
    ],
    commonTraps: [
      {
        name: 'Гиперконтроль',
        description: 'Попытка предусмотреть все, чтобы не быть застигнутой врасплох',
      },
      {
        name: 'Эмоциональная недоступность',
        description: 'Закрытость и дистанция как защита от боли',
      },
      {
        name: 'Манипуляция силой',
        description: 'Использование власти, чтобы скрыть слабость',
      },
    ],
    scenarios: [
      {
        setting: 'Крыша небоскрёба в ветреную ночь',
        situation: 'Ты держишься за перила, но кто-то зовёт тебя отпустить руки и довериться',
        symbolism: 'Отпускание контроля как свободное падение',
      },
      {
        setting: 'Тёмный лес с узкой тропой',
        situation: 'Твой фонарик гаснет, и ты должна идти в темноте или остаться на месте до утра',
        symbolism: 'Движение в неизвестность без карты',
      },
      {
        setting: 'Замёрзшее озеро в сумерках',
        situation: 'Ты идёшь по льду, который начинает трещать, и нужно выбрать: бежать или замереть',
        symbolism: 'Хрупкость контроля и риск провала',
      },
    ],
    choicePoints: [
      'Отпустить контроль или держаться крепче?',
      'Показать слабость или сохранить маску?',
      'Довериться или рассчитывать только на себя?',
    ],
  },
  {
    id: 'authenticity-vs-expectations',
    question: 'Что останется, если я перестану соответствовать чужим ожиданиям?',
    theme: 'Идентичность и роли',
    astroIndicators: [
      'Солнце в напряжении с Сатурном/Плутоном',
      'Луна в 10-м доме или в Козероге',
      'Сильный 10-й дом при слабом 4-м/5-м',
    ],
    commonTraps: [
      {
        name: 'Перфекционизм',
        description: 'Стремление быть идеальной версией для всех',
      },
      {
        name: 'Потеря себя в ролях',
        description: 'Игра столько ролей, что забыла, кто ты без них',
      },
      {
        name: 'Страх отвержения',
        description: 'Уверенность, что настоящую тебя не примут',
      },
    ],
    scenarios: [
      {
        setting: 'Театр после спектакля, пустая гримёрка',
        situation: 'Ты снимаешь грим и видишь в зеркале незнакомое лицо',
        symbolism: 'Маска и лицо под ней',
      },
      {
        setting: 'Примерочная в закрытом магазине',
        situation: 'Ты застряла в чужой одежде, которая казалась идеальной, но душит',
        symbolism: 'Чужие образы и поиск своего стиля',
      },
      {
        setting: 'Студия звукозаписи, пустая будка',
        situation: 'Ты должна записать голосовое сообщение, но не знаешь, каким голосом говорить',
        symbolism: 'Настоящий голос vs социально приемлемый',
      },
    ],
    choicePoints: [
      'Снять маску или надеть ещё одну?',
      'Сказать правду или то, что от тебя ждут?',
      'Быть собой или удобной версией себя?',
    ],
  },
  {
    id: 'release-past',
    question: 'Как отпустить прошлое, которое всё ещё держит меня?',
    theme: 'Прошлое и освобождение',
    astroIndicators: [
      'Сатурн в 4-м или 12-м доме',
      'Плутон в аспекте к Луне/IC',
      'Южный узел с личными планетами',
    ],
    commonTraps: [
      {
        name: 'Застревание в прошлом',
        description: 'Бесконечное переживание старых обид и травм',
      },
      {
        name: 'Идеализация/демонизация',
        description: 'Превращение прошлого в рай или ад, чтобы не видеть правды',
      },
      {
        name: 'Месть как зависание',
        description: 'Желание отомстить держит связь с прошлым',
      },
    ],
    scenarios: [
      {
        setting: 'Подвал старого дома с коробками',
        situation: 'Ты разбираешь вещи, и каждая вещь — воспоминание. Оставить или выбросить?',
        symbolism: 'Материализация памяти и расставание',
      },
      {
        setting: 'Берег моря в шторм',
        situation: 'Волны смывают песчаный замок, который ты строила годами',
        symbolism: 'Разрушение старых структур',
      },
      {
        setting: 'Заброшенный дом детства',
        situation: 'Ты пришла попрощаться, но призраки прошлого не хотят отпускать',
        symbolism: 'Возвращение к истокам для завершения',
      },
    ],
    choicePoints: [
      'Оставить память или отпустить?',
      'Простить или держать обиду?',
      'Вернуться в прошлое или шагнуть в будущее?',
    ],
  },
];

/**
 * Выбирает контракт на основе астрологических показателей из натальной карты
 */
export function selectContractByAstrology(
  corePlacements: string[],
  hardAspects: string[],
): PsychologicalContract {
  // Ищем совпадения с астрологическими индикаторами
  const matches = PSYCHOLOGICAL_CONTRACTS.map(contract => {
    let score = 0;
    const allAstroData = [...corePlacements, ...hardAspects].join(' ').toLowerCase();

    for (const indicator of contract.astroIndicators) {
      const keywords = indicator.toLowerCase().match(/\b(луна|солнце|венера|марс|меркурий|сатурн|плутон|юпитер|уран|квадрат|оппозиция|козерог|скорпион|рак|дева|близнецы|дом)\b/g) || [];
      for (const keyword of keywords) {
        if (allAstroData.includes(keyword)) {
          score++;
        }
      }
    }

    return { contract, score };
  });

  // Сортируем по совпадениям и выбираем случайный из топ-3
  matches.sort((a, b) => b.score - a.score);
  const topMatches = matches.slice(0, 3);
  const selected = topMatches[Math.floor(Math.random() * topMatches.length)];

  return selected.contract;
}

/**
 * Выбирает случайный сценарий из контракта
 */
export function selectScenario(contract: PsychologicalContract): ContractScenario {
  return contract.scenarios[Math.floor(Math.random() * contract.scenarios.length)];
}
