import { callAI, type AIMessage } from './aiClient';
import {
  ASTRO_PROFILES,
  PRIMARY_PROFILE_ID,
  type AstroProfile,
} from '../data/astroProfiles';
import {
  buildNatalChartAnalysis,
  type NatalChartAnalysis,
} from './astro';
import {
  findScenarioById,
  getFallbackContract,
  normalizePsychologicalContract,
  type PsychologicalContract,
  type ContractScenario,
} from '../data/psychologicalContracts';
import {
  getPsychContractHistorySnapshot,
  rememberContractUsage,
} from './psychContractHistory';

export interface HistoryStoryOption {
  id: string;
  title: string;
  description: string;
}

export interface HistoryStoryMeta {
  author: string;
  title: string;
  genre: string;
  contract: string;
  moonSummary: string; // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –õ—É–Ω—ã, –ø–æ–¥–≤–æ–¥—è—â–µ–µ –∏—Ç–æ–≥ –¥–∏–∞–ª–æ–≥–∞ –∏ –æ–±—ä—è—Å–Ω—è—é—â–µ–µ –≤—ã–±–æ—Ä —Ç–µ–º—ã
  arcLimit: number;
}

export interface HistoryStoryNodeInfo {
  arc: number;
  stage: string;
  scene: string;
}

export interface HistoryStoryFinale {
  resolution: string;
  humanInterpretation: string;
  astrologicalInterpretation: string;
}

export interface HistoryStoryResponse {
  meta?: HistoryStoryMeta;
  node?: HistoryStoryNodeInfo;
  options: HistoryStoryOption[];
  finale?: HistoryStoryFinale;
}

export interface HistoryStoryContextSegment {
  /**
   * Text that has already been shown to the user.
   */
  text: string;
  /**
   * Arc number associated with this segment.
   */
  arc: number;
  /**
   * Optional short title of the option that lead to this segment.
   */
  optionTitle?: string;
  /**
   * Optional explanation of the option that lead to this segment.
   */
  optionDescription?: string;
}

export interface HistoryStoryAuthorStyle {
  name: string;
  stylePrompt: string;
  genre: string;
}

export interface HistoryStoryRequestOptions {
  /**
   * Previously generated story fragments, ordered chronologically.
   * The last element corresponds to the most recent paragraph.
   */
  segments: HistoryStoryContextSegment[];
  /**
   * Optional direction that the user –≤—ã–±—Ä–∞–ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞.
   */
  currentChoice?: HistoryStoryOption;
  /**
   * Optional short summary of earlier events to reduce prompt length.
   */
  summary?: string;
  /**
   * Author persona that should narrate the story.
   */
  author: HistoryStoryAuthorStyle;
  /**
   * Total number of arcs expected in the story.
   */
  arcLimit: number;
  /**
   * Generation mode: either next arc or finale.
   */
  mode: 'arc' | 'finale';
  /**
   * Arc number that should be produced (required for arc mode).
   */
  currentArc?: number;
  /**
   * Previously established story contract, if any.
   */
  contract?: string;
  /**
   * Optional AbortSignal to cancel the AI request.
   */
  signal?: AbortSignal;
  /**
   * Optional Claude API key.
   */
  claudeApiKey?: string;
  /**
   * Optional Claude proxy URL.
   */
  claudeProxyUrl?: string;
  /**
   * Optional OpenAI API key for fallback.
   */
  openAIApiKey?: string;
  /**
   * Optional OpenAI proxy URL.
   */
  openAIProxyUrl?: string;
}

const STORY_STAGE_NAMES = [
  '–ó–∞–≤—è–∑–∫–∞',
  '–û–±–æ—Å—Ç—Ä–µ–Ω–∏–µ',
  '–í—ã–±–æ—Ä',
  '–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è',
  '–ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è',
  '–ü–æ–≤–æ—Ä–æ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç',
] as const;

const STORY_STAGE_GUIDANCE: Record<string, string> = {
  –ó–∞–≤—è–∑–∫–∞: '–ü–æ–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∂–∏–∑–Ω–µ–Ω–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é, –≤ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç. –û–±—ã—á–Ω–∞—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞, —Ä–µ–∞–ª—å–Ω—ã–µ –ª—é–¥–∏, –ø–æ–Ω—è—Ç–Ω–∞—è –¥–∏–ª–µ–º–º–∞.',
  –û–±–æ—Å—Ç—Ä–µ–Ω–∏–µ: '–£—Å–∏–ª—å –¥–∞–≤–ª–µ–Ω–∏–µ: –¥—Ä—É–≥–∏–µ –ª—é–¥–∏ –¥–∞–≤—è—Ç, –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ —Ç—Ä–µ–±—É—é—Ç —Ä–µ—à–µ–Ω–∏—è, –≤—Ä–µ–º—è –ø–æ–¥–∂–∏–º–∞–µ—Ç. –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Ä–∞—Å—Ç—ë—Ç.',
  –í—ã–±–æ—Ä: '–ì–µ—Ä–æ–∏–Ω—è –¥–æ–ª–∂–Ω–∞ –≤—ã–±—Ä–∞—Ç—å: –ø–æ–π—Ç–∏ –ø—Ä–∏–≤—ã—á–Ω—ã–º –ø—É—Ç—ë–º (–ª–æ–≤—É—à–∫–∞) –∏–ª–∏ —Ä–∏—Å–∫–Ω—É—Ç—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É.',
  –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: '–ü–æ–∫–∞–∂–∏, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞. –†–µ–∞–∫—Ü–∏–∏ –ª—é–¥–µ–π, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞, —Ü–µ–Ω–∞ —Ä–µ—à–µ–Ω–∏—è.',
  –ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è: '–°–∞–º—ã–π –æ—Å—Ç—Ä—ã–π –º–æ–º–µ–Ω—Ç: –≥–µ—Ä–æ–∏–Ω—è —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è —Å –≥–ª–∞–≤–Ω—ã–º —Å—Ç—Ä–∞—Ö–æ–º –∏–ª–∏ –±–æ–ª—å—é —ç—Ç–æ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞.',
  '–ü–æ–≤–æ—Ä–æ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç': '–í–ê–ñ–ù–û: –≠—Ç–æ –ù–ï —Ñ–∏–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏! –ì–µ—Ä–æ–∏–Ω—è –¥–µ–ª–∞–µ—Ç –∫–ª—é—á–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —Ä–∞–∑–≤—è–∑–∫–µ. –ü—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ü–µ–Ω–∞ –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª–æ–º.',
};

const CONTEXT_LIMIT = 10; // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ª—É—á—à–µ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏–∏ (–±—ã–ª–æ 4)

const FALLBACK_OPTIONS: [HistoryStoryOption, HistoryStoryOption] = [
  {
    id: 'stand-ground',
    title: '–°–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–¥—É',
    description: '–ß–µ—Å—Ç–Ω–æ –æ–∑–≤—É—á–∏—Ç—å —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ.',
  },
  {
    id: 'stay-quiet',
    title: '–ü—Ä–æ–º–æ–ª—á–∞—Ç—å',
    description: '–ü—Ä–æ–º–æ–ª—á–∞—Ç—å —Ä–∞–¥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∏—Ä–∞ –∏ –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞.',
  },
];

const DEFAULT_CONTRACT = '–ú–æ–≥—É –ª–∏ —è –∑–∞—â–∏—Ç–∏—Ç—å —Å–≤–æ–∏ –≥—Ä–∞–Ω–∏—Ü—ã, –Ω–µ —á—É–≤—Å—Ç–≤—É—è —Å–µ–±—è –ø–ª–æ—Ö–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º?';

// DEFAULT –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã - fallback –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏–∏

const NASTIA_PROFILE = ASTRO_PROFILES[PRIMARY_PROFILE_ID];
const NASTIA_CHART_ANALYSIS = buildNatalChartAnalysis(PRIMARY_PROFILE_ID);
const BIRTH_DATA_TEXT = serializeBirthData(NASTIA_PROFILE);
const CHART_ANALYSIS_TEXT = serializeChartAnalysis(NASTIA_CHART_ANALYSIS);

interface PsychContractContext {
  contract: PsychologicalContract;
  scenario?: ContractScenario;
}

let activePsychContext: PsychContractContext | undefined;

function serializeBirthData(profile: AstroProfile): string {
  const locationNote = profile.notes?.split('(')[0]?.trim() ?? '–¢–∏–∫—Å–∏, –†–æ—Å—Å–∏—è';
  const time = profile.birthTime ?? '12:00';
  return `{
  "date": "${profile.birthDate}",
  "time": "${time}",
  "timezone": "${profile.timeZone}",
  "location": "${locationNote}",
  "latitude": ${profile.latitude},
  "longitude": ${profile.longitude}
}`;
}

function serializeChartAnalysis(analysis: NatalChartAnalysis): string {
  const formatSection = (label: string, values: string[]): string => {
    if (!values.length) {
      return `${label}: []`;
    }
    return `${label}:\n- ${values.join('\n- ')}`;
  };

  return [
    formatSection('core_placements', analysis.corePlacements),
    formatSection('hard_aspects', analysis.hardAspects),
    formatSection('soft_aspects', analysis.softAspects),
  ].join('\n');
}

function indent(text: string, spaces = 2): string {
  const pad = ' '.repeat(spaces);
  return text
    .split('\n')
    .map(line => (line.length ? pad + line : line))
    .join('\n');
}

function getStageName(arc: number, arcLimit: number): string {
  const index = Math.max(0, Math.min(STORY_STAGE_NAMES.length - 1, arc - 1));
  return STORY_STAGE_NAMES[index] ?? STORY_STAGE_NAMES[STORY_STAGE_NAMES.length - 1];
}

function getStageGuidance(stage: string): string {
  return STORY_STAGE_GUIDANCE[stage] ?? '';
}

function trimString(value: unknown): string {
  return typeof value === 'string' ? value.trim() : '';
}

/**
 * –£–º–Ω–∞—è –∑–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤ JSON:
 * - –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ JSON (–º–µ–∂–¥—É –∫–∞–≤—ã—á–∫–∞–º–∏)
 * - –ó–∞–º–µ–Ω—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
 * - –û—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã JSON (–∑–∞–ø—è—Ç—ã–µ, —Å–∫–æ–±–∫–∏) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
 */
function fixSmartNewlines(jsonText: string): string {
  let result = '';
  let insideString = false;
  let prevChar = '';

  for (let i = 0; i < jsonText.length; i++) {
    const char = jsonText[i];

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    if (char === '"' && prevChar !== '\\') {
      insideString = !insideString;
      result += char;
    } else if (insideString && (char === '\n' || char === '\r')) {
      // –í–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏: –∑–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –ø—Ä–æ–±–µ–ª
      result += ' ';
    } else {
      result += char;
    }

    prevChar = char;
  }

  return result;
}

async function generatePsychContractContext(
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  openAIProxyUrl?: string,
): Promise<PsychContractContext> {
  const historySnapshot = getPsychContractHistorySnapshot();
  const recentContractIds = historySnapshot.contracts.slice(0, 8).map(entry => entry.id);
  const recentScenarios = historySnapshot.scenarios.slice(0, 12).map(
    entry => `${entry.contractId}/${entry.scenarioId}`,
  );

  const prompt = `–¢—ã ‚Äî –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥–∫–∞, —Å–æ–∑–¥–∞—é—â–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ.

–¢–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–¥—É–º–∞—Ç—å —Å–≤–µ–∂–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –ù–∞—Å—Ç–∏. –û–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞–¥–æ –Ω–∞ –µ—ë –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –∏ –∏–∑–±–µ–≥–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø—Ä–æ—à–ª—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤/—Å—Ü–µ–Ω.

üîπ –î–ê–ù–ù–´–ï
birth_data:
${indent(BIRTH_DATA_TEXT, 2)}
chart_analysis:
${indent(CHART_ANALYSIS_TEXT, 2)}
recent_contract_ids: ${JSON.stringify(recentContractIds)}
recent_scenarios: ${JSON.stringify(recentScenarios)}

üîπ –ó–ê–î–ê–ù–ò–ï
1. –û—Å–º—ã—Å–ª–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ù–û–í–´–ô –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç (–∫–æ–Ω—Ç—Ä–∞–∫—Ç).
2. –ö–æ–Ω—Ç—Ä–∞–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Å—Ç—ã–º, –ø–æ–Ω—è—Ç–Ω—ã–º –≤–æ–ø—Ä–æ—Å–æ–º –∏–∑ –∂–∏–∑–Ω–∏ ‚Äî –ë–ï–ó –º–µ—Ç–∞—Ñ–æ—Ä –∏ —Å–ª–æ–∂–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.
3. –û–ø–∏—à–∏ 3 –ª–æ–≤—É—à–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã, —Å–∞–º–æ–æ–±–º–∞–Ω).
4. –ü—Ä–∏–¥—É–º–∞–π 3 –†–ï–ê–õ–¨–ù–´–ï –ñ–ò–ó–ù–ï–ù–ù–´–ï –°–ò–¢–£–ê–¶–ò–ò (–Ω–µ –º–∏—Å—Ç–∏–∫—É!).
   - –ó–ê–ü–†–ï–©–ï–ù–û: –ø—É—Å—Ç—ã–µ –º–µ—Ç—Ä–æ, –∑–∞–±—Ä–æ—à–µ–Ω–Ω—ã–µ –¥–æ–º–∞, –∫—Ä—ã—à–∏, —Ç—ë–º–Ω—ã–µ –ª–µ—Å–∞, –∑–∞–º—ë—Ä–∑—à–∏–µ –æ–∑—ë—Ä–∞, –ª—é–±–∞—è –º–∏—Å—Ç–∏–∫–∞
   - –ù–£–ñ–ù–û: –æ—Ñ–∏—Å, –∫–≤–∞—Ä—Ç–∏—Ä–∞, –∫–∞—Ñ–µ, –ø–∞—Ä–∫, –¥–æ–º —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –≤—Å—Ç—Ä–µ—á–∞ —Å –¥—Ä—É–∑—å—è–º–∏ ‚Äî –æ–±—ã—á–Ω—ã–µ –º–µ—Å—Ç–∞
5. –î–æ–±–∞–≤—å 3 –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –≤—ã–±–æ—Ä–∞ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ –¥–∏–ª–µ–º–º—ã.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–ï:
6. –ü–û–°–ú–û–¢–†–ò –Ω–∞ recent_contract_ids –≤—ã—à–µ! –ï—Å–ª–∏ —Ç–∞–º:
   - work/career/job ‚Üí –ù–ï –ø–∏—à–∏ –ø—Ä–æ —Ä–∞–±–æ—Ç—É! –í—ã–±–µ—Ä–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Å–µ–º—å—é –∏–ª–∏ —Ö–æ–±–±–∏
   - family/parent ‚Üí –ù–ï –ø–∏—à–∏ –ø—Ä–æ —Å–µ–º—å—é! –í—ã–±–µ—Ä–∏ —Ä–∞–±–æ—Ç—É, –¥—Ä—É–∂–±—É –∏–ª–∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ
   - friend/friendship ‚Üí –ù–ï –ø–∏—à–∏ –ø—Ä–æ –¥—Ä—É–∑–µ–π! –í—ã–±–µ—Ä–∏ –ª—é–±–æ–≤—å, —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ –∏–ª–∏ —Ñ–∏–Ω–∞–Ω—Å—ã
   - relationship/love ‚Üí –ù–ï –ø–∏—à–∏ –ø—Ä–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è! –í—ã–±–µ—Ä–∏ —Ö–æ–±–±–∏, –∑–¥–æ—Ä–æ–≤—å–µ –∏–ª–∏ —Ä–∞–±–æ—Ç—É
   - social ‚Üí –ù–ï –ø–∏—à–∏ –ø—Ä–æ –æ–±—â–µ—Å—Ç–≤–æ! –í—ã–±–µ—Ä–∏ —á—Ç–æ-—Ç–æ –ª–∏—á–Ω–æ–µ

7. –ß–µ—Ä–µ–¥—É–π 9 —Å—Ñ–µ—Ä –∂–∏–∑–Ω–∏: —Ä–∞–±–æ—Ç–∞, –ª—é–±–æ–≤—å, –¥—Ä—É–∂–±–∞, —Å–µ–º—å—è, —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ, —Ö–æ–±–±–∏, –∑–¥–æ—Ä–æ–≤—å–µ, —Ñ–∏–Ω–∞–Ω—Å—ã, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ

8. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –ø–æ —Å—Ñ–µ—Ä–∞–º:

   –†–ê–ë–û–¢–ê: "–ú–æ–≥—É –ª–∏ —è –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω–æ–π?", "–°—Ç–æ–∏—Ç –ª–∏ –º–µ–Ω—è—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é?"
   –õ–Æ–ë–û–í–¨: "–ú–æ–≥—É –ª–∏ —è –±—ã—Ç—å —É—è–∑–≤–∏–º–æ–π –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?", "–ü–æ—Ä–∞ –ª–∏ —Ä–∞—Å—Å—Ç–∞—Ç—å—Å—è?"
   –°–ï–ú–¨–Ø: "–ú–æ–≥—É –ª–∏ —è –æ—Ç–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º?", "–ö–∞–∫ –æ—Ç–¥–µ–ª–∏—Ç—å—Å—è –æ—Ç —Å–µ–º—å–∏?"
   –î–†–£–ñ–ë–ê: "–ú–æ–≥—É –ª–∏ —è –æ—Ç–∫–∞–∑–∞—Ç—å —Ç–æ–∫—Å–∏—á–Ω–æ–π –ø–æ–¥—Ä—É–≥–µ?", "–ü–æ—Ä–∞ –ª–∏ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –¥—Ä—É–∂–±—É?"
   –°–ê–ú–û–†–ê–ó–í–ò–¢–ò–ï: "–ú–æ–≥—É –ª–∏ —è –≤—ã–π—Ç–∏ –∏–∑ –∑–æ–Ω—ã –∫–æ–º—Ñ–æ—Ä—Ç–∞?", "–°—Ç–æ–∏—Ç –ª–∏ –Ω–∞—á–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ?"
   –¢–í–û–†–ß–ï–°–¢–í–û: "–ú–æ–≥—É –ª–∏ —è –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ?", "–ò–º–µ—é –ª–∏ –ø—Ä–∞–≤–æ –Ω–∞ —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ?"
   –•–û–ë–ë–ò: "–ú–æ–≥—É –ª–∏ —è —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Ö–æ–±–±–∏?", "–ù–µ —ç–≥–æ–∏–∑–º –ª–∏ –¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ –¥–ª—è —Å–µ–±—è?"
   –ó–î–û–†–û–í–¨–ï: "–ú–æ–≥—É –ª–∏ —è –æ—Ç–¥—ã—Ö–∞—Ç—å –±–µ–∑ –≤–∏–Ω—ã?", "–°—Ç–æ–∏—Ç –ª–∏ –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ?"
   –§–ò–ù–ê–ù–°–´: "–ú–æ–≥—É –ª–∏ —è —Ç—Ä–∞—Ç–∏—Ç—å –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å–µ–±—è?", "–ö–∞–∫ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã?"

9. –ü–†–û–í–ï–†–¨ –°–ï–ë–Ø: –µ—Å–ª–∏ —Ç–≤–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ—Ö–æ–∂ –Ω–∞ —á—Ç–æ-—Ç–æ –∏–∑ recent_contract_ids - –ù–ê–ß–ù–ò –ó–ê–ù–û–í–û —Å –¥—Ä—É–≥–æ–π —Å—Ñ–µ—Ä–æ–π!

üîπ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –°–¢–†–£–ö–¢–£–†–ï
- contract.id ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π kebab-case –ª–∞—Ç–∏–Ω–∏—Ü–µ–π –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: career-vs-family).
- contract.question ‚Äî –ø—Ä–æ—Å—Ç–æ–π –ø–æ–Ω—è—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ë–ï–ó –º–µ—Ç–∞—Ñ–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ú–æ–≥—É –ª–∏ —è –æ—Ç–∫–∞–∑–∞—Ç—å –º–∞–º–µ, –µ—Å–ª–∏ —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–µ–Ω—è?").
- contract.theme ‚Äî –æ–¥–Ω–æ-–¥–≤–∞ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª–æ–≤–∞ –∏–∑ –∂–∏–∑–Ω–∏.
- contract.astroIndicators ‚Äî 3‚Äì4 –º–∞—Ä–∫–µ—Ä–∞ (—Ç–µ–∫—Å—Ç–æ–º, –º–æ–∂–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º).
- contract.commonTraps ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ —Ç—Ä—ë—Ö –æ–±—ä–µ–∫—Ç–æ–≤ { "name": "...", "description": "..." }.
- contract.scenarios ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ —Ç—Ä—ë—Ö –†–ï–ê–õ–¨–ù–´–• –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π { "id": "kebab-case", "setting": "–û–ë–´–ß–ù–û–ï –ú–ï–°–¢–û (–æ—Ñ–∏—Å/–∫–∞—Ñ–µ/–¥–æ–º)", "situation": "–ö–û–ù–ö–†–ï–¢–ù–ê–Ø –ñ–ò–ó–ù–ï–ù–ù–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø", "symbolism": "–∫—Ä–∞—Ç–∫–∏–π —Å–º—ã—Å–ª" }.
- contract.choicePoints ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ —Ç—Ä—ë—Ö –°–¢–†–û–ö (–ù–ï –æ–±—ä–µ–∫—Ç–æ–≤!) —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º–∏ –≤—ã–±–æ—Ä–∞–º–∏. –ü—Ä–∏–º–µ—Ä: ["–û—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ –∏–ª–∏ –ø–æ–µ—Ö–∞—Ç—å –≤ –æ—Ç–ø—É—Å–∫?", "–ü–æ–º–æ—á—å –ø–æ–¥—Ä—É–≥–µ –∏–ª–∏ –æ—Ç–∫–∞–∑–∞—Ç—å?", "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å?"]
- recommendedScenarioId ‚Äî id —Å—Ü–µ–Ω—ã, —Å –∫–æ—Ç–æ—Ä–æ–π –ª—É—á—à–µ –Ω–∞—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é.
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏–π, –Ω–æ id –æ—Å—Ç–∞–≤—å –ª–∞—Ç–∏–Ω–∏—Ü–µ–π.

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –°–¶–ï–ù–ê–†–ò–ï–í:
‚úÖ "–û—Ñ–∏—Å –≤ –ø—è—Ç–Ω–∏—Ü—É –≤–µ—á–µ—Ä–æ–º: –Ω–∞—á–∞–ª—å–Ω–∏–∫ –ø—Ä–æ—Å–∏—Ç –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ —Ä–∞–¥–∏ –ø—Ä–æ–µ–∫—Ç–∞, –Ω–æ —Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–∞ –ø–æ–µ–∑–¥–∫—É"
‚úÖ "–ö—É—Ö–Ω—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã: –º–∞–º–∞ –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ —Ç—ã —ç–≥–æ–∏—Å—Ç–∫–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ –ø—Ä–∏–µ–¥–µ—à—å –ø–æ–º–æ–≥–∞—Ç—å —Å —Ä–µ–º–æ–Ω—Ç–æ–º"
‚úÖ "–ö–∞—Ñ–µ —Å –ø–æ–¥—Ä—É–≥–æ–π: –æ–Ω–∞ –≤ —Ç—Ä–µ—Ç–∏–π —Ä–∞–∑ –∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ, –∏ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ —É—Å—Ç–∞–ª–∞ —Å–ª—É—à–∞—Ç—å"

–ü–†–ò–ú–ï–†–´ –ü–õ–û–•–ò–• –°–¶–ï–ù–ê–†–ò–ï–í:
‚ùå "–ü—É—Å—Ç–∞—è —Å—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ –≤ —á–∞—Å –Ω–æ—á–∏ —Å –º–∏–≥–∞—é—â–∏–º —Ç–∞–±–ª–æ"
‚ùå "–ó–∞–±—Ä–æ—à–µ–Ω–Ω—ã–π –¥–æ–º –¥–µ—Ç—Å—Ç–≤–∞ —Å –ø—Ä–∏–∑—Ä–∞–∫–∞–º–∏ –ø—Ä–æ—à–ª–æ–≥–æ"
‚ùå "–ö—Ä—ã—à–∞ –Ω–µ–±–æ—Å–∫—Ä—ë–±–∞ –≤ –≤–µ—Ç—Ä–µ–Ω—É—é –Ω–æ—á—å"

üîπ –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤):
{
  "contract": { ...—Å–º. –≤—ã—à–µ... },
  "recommendedScenarioId": "scenario-id"
}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø –§–û–†–ú–ê–¢–ê JSON:
1. –í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –û–î–ù–£ —Å—Ç—Ä–æ–∫—É –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫.
2. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏ (\\n) –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
3. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–±–µ–ª—ã –≤–º–µ—Å—Ç–æ –ª—é–±—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞.
4. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π –µ–≥–æ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–æ–±–µ–ª–∞–º–∏.
5. JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º –∏ –≤–∞–ª–∏–¥–Ω—ã–º –¥–ª—è JSON.parse().

–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON –∏ Markdown.`;

  try {
    const result = await callAI({
      system:
        '–¢—ã –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏—Å—Ç–æ—Ä–∏–π. –ü—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –∏–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤ –∏ –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ JSON.',
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.85,
      maxTokens: 2500,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
      openAIProxyUrl,
    });

    let text = result.text.trim();
    text = text.replace(/```json\s*/gi, '').replace(/```/g, '').trim();

    let parsed: any;
    try {
      parsed = JSON.parse(text);
    } catch (parseError) {
      console.error('[PsychContract] JSON parse error:', parseError);
      console.error('[PsychContract] Raw text length:', text.length, 'chars');
      console.error('[PsychContract] Raw text (first 500 chars):', text.slice(0, 500));
      console.error('[PsychContract] Raw text (last 200 chars):', text.slice(-200));

      // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ JSON
      try {
        // –£–º–Ω–∞—è –∑–∞–º–µ–Ω–∞: –∑–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ–±–µ–ª—ã,
        // –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –º–µ–∂–¥—É –∫–ª—é—á–∞–º–∏
        let fixedText = fixSmartNewlines(text);
        parsed = JSON.parse(fixedText);
        console.log('[PsychContract] ‚úÖ Successfully parsed after fixing newlines');
      } catch (fixError) {
        console.error('[PsychContract] Smart fix failed:', fixError);
        console.error('[PsychContract] Trying aggressive cleanup');

        // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞: —É–±–∏—Ä–∞–µ–º –í–°–ï –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        try {
          let aggressiveText = text
            .replace(/\\n/g, ' ')
            .replace(/[\r\n]+/g, ' ')
            .replace(/\t/g, ' ')
            .replace(/\s+/g, ' ');
          parsed = JSON.parse(aggressiveText);
          console.log('[PsychContract] ‚úÖ Successfully parsed after aggressive cleanup');
        } catch (aggressiveError) {
          console.error('[PsychContract] Aggressive cleanup failed, trying to extract valid JSON');

          // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –∏—â–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ —á–∞—Å—Ç–∏ JSON
          try {
            const lastBrace = text.lastIndexOf('}');
            if (lastBrace > 0) {
              const truncated = text.substring(0, lastBrace + 1);
              const fixedTruncated = truncated
                .replace(/[\r\n]+/g, ' ')
                .replace(/\s+/g, ' ');
              parsed = JSON.parse(fixedTruncated);
              console.log('[PsychContract] ‚ö†Ô∏è Successfully parsed truncated JSON (incomplete response)');
            } else {
              throw parseError;
            }
          } catch (truncError) {
            console.error('[PsychContract] All parsing attempts failed, using fallback');
            throw parseError;
          }
        }
      }
    }

    console.log('[PsychContract] Parsed response:', JSON.stringify(parsed, null, 2));

    const contract = normalizePsychologicalContract(parsed?.contract ?? parsed);
    if (!contract) {
      console.error('[PsychContract] Failed to normalize contract. Raw data:', parsed);
      throw new Error('–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç');
    }

    console.log('[PsychContract] ‚úÖ Contract validated:', contract.id, contract.question);

    const recommendedScenarioId = trimString(
      parsed?.recommendedScenarioId ?? parsed?.recommended_scenario_id ?? '',
    );
    const scenario = findScenarioById(contract, recommendedScenarioId);

    rememberContractUsage(contract.id, scenario.id);

    return {
      contract,
      scenario,
    };
  } catch (error) {
    console.warn('[PsychContract] Failed to generate via AI, using fallback', error);
    const fallback = getFallbackContract(recentContractIds, recentScenarios);
    const fallbackScenario = findScenarioById(
      fallback.contract,
      fallback.recommendedScenarioId,
    );
    rememberContractUsage(fallback.contract.id, fallbackScenario.id);
    return {
      contract: fallback.contract,
      scenario: fallbackScenario,
    };
  }
}

async function ensurePsychContractContext(
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  openAIProxyUrl?: string,
): Promise<PsychContractContext> {
  if (activePsychContext) {
    return activePsychContext;
  }

  activePsychContext = await generatePsychContractContext(
    claudeApiKey,
    claudeProxyUrl,
    openAIApiKey,
    openAIProxyUrl,
  );
  return activePsychContext;
}

export function clearPsychContractContext(): void {
  activePsychContext = undefined;
}

function buildPsychologicalContractInfo(
  contract?: PsychologicalContract,
  scenario?: ContractScenario,
): string {
  if (!contract) {
    return '';
  }

  const trapsText = contract.commonTraps
    .map(trap => `‚Ä¢ ${trap.name}: ${trap.description}`)
    .join('\n');

  const scenarioText = scenario
    ? `–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
- –û–±—Å—Ç–∞–Ω–æ–≤–∫–∞: ${scenario.setting}
- –°–∏—Ç—É–∞—Ü–∏—è: ${scenario.situation}
- –°–∏–º–≤–æ–ª–∏–∑–º: ${scenario.symbolism}`
    : '';

  return `
üîπ –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ö–û–ù–¢–†–ê–ö–¢

–û—Å–Ω–æ–≤–Ω–æ–π –≤–æ–ø—Ä–æ—Å: ¬´${contract.question}¬ª
–¢–µ–º–∞: ${contract.theme}

–¢–∏–ø–∏—á–Ω—ã–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ª–æ–≤—É—à–∫–∏:
${trapsText}

–ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –≤—ã–±–æ—Ä–∞:
${contract.choicePoints.map(point => `‚Ä¢ ${point}`).join('\n')}

${scenarioText}

–í–ê–ñ–ù–û: –ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–π, –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –≥–µ—Ä–æ–∏–Ω—è –≤ –æ–¥–Ω—É –∏–∑ –ª–æ–≤—É—à–µ–∫.
–í—ã–±–æ—Ä—ã –¥–æ–ª–∂–Ω—ã —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —ç—Ç–∏ –ª–æ–≤—É—à–∫–∏ –∏ –¥–∞–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–≤–∏–¥–µ—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω.`;
}

function buildStorySoFar(
  segments: HistoryStoryContextSegment[],
  arcLimit: number,
  summary?: string,
): string {
  if (!segments.length) {
    return '–ò—Å—Ç–æ—Ä–∏—è –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å.';
  }

  const recentSegments = segments.slice(-CONTEXT_LIMIT);

  const parts = recentSegments.map((segment, index) => {
    const stage = getStageName(segment.arc, arcLimit);
    const choiceLine = segment.optionTitle
      ? `>>> –í—ã–±–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤—ë–ª –∫ —ç—Ç–æ–π —Å—Ü–µ–Ω–µ: ¬´${segment.optionTitle}¬ª ‚Äî ${
          segment.optionDescription || ''
        }`
      : '>>> –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞';
    const sceneLabel = `[–°—Ü–µ–Ω–∞ ${segment.arc}/${arcLimit}: ${stage}]`;
    return `${sceneLabel}\n${choiceLine}\n${segment.text}`;
  });

  if (summary && summary.trim().length > 0) {
    return `${summary.trim()}\n\n${parts.join('\n\n')}`;
  }

  return parts.join('\n\n');
}

function buildInputDataBlock(genre: string, arcLimit: number): string {
  return `üîπ –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï

user_name: ${NASTIA_PROFILE.name}
birth_data:
${indent(BIRTH_DATA_TEXT, 2)}
chart_analysis:
${indent(CHART_ANALYSIS_TEXT, 2)}
story_genre: ${genre}
arc_limit: ${arcLimit}
language: ru`;
}

interface ArcPromptArgs {
  segments: HistoryStoryContextSegment[];
  currentChoice?: HistoryStoryOption;
  summary?: string;
  author: HistoryStoryAuthorStyle;
  arcLimit: number;
  currentArc: number;
  contract?: string;
}

function buildArcPrompt(args: ArcPromptArgs, psychContext?: PsychContractContext): string {
  const {
    segments,
    currentChoice,
    summary,
    author,
    arcLimit,
    currentArc,
    contract,
  } = args;

  const stage = getStageName(currentArc, arcLimit);
  const stageGuidance = getStageGuidance(stage);
  const storyContext = buildStorySoFar(segments, arcLimit, summary);

  const choiceInstruction = currentChoice
    ? `–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –≠—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –û–î–ù–û–ô –∏—Å—Ç–æ—Ä–∏–∏!
–ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä –ù–∞—Å—Ç–∏: ¬´${currentChoice.title}¬ª${currentChoice.description ? ` (${currentChoice.description})` : ''}.
–ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ü–†–Ø–ú–´–ú –ü–û–°–õ–ï–î–°–¢–í–ò–ï–ú —ç—Ç–æ–≥–æ –≤—ã–±–æ—Ä–∞.
–ü–æ–∫–∞–∂–∏, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∞ —Å–¥–µ–ª–∞–ª–∞ —ç—Ç–æ—Ç –≤—ã–±–æ—Ä.
–°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –º–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è –∏ —Å–∏—Ç—É–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å—Ü–µ–Ω.`
    : '–≠—Ç–æ –ø–µ—Ä–≤—ã–π —É–∑–µ–ª ‚Äî –Ω–∞—á–∏–Ω–∞–π —Å—Ä–∞–∑—É —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏.';

  const psychContract = psychContext?.contract;
  const psychScenario = currentArc === 1 ? psychContext?.scenario : undefined;

  const contractInstruction = contract
    ? `–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏—Å—Ç–æ—Ä–∏–∏ —É–∂–µ –∑–∞–¥–∞–Ω: ¬´${contract}¬ª. –°–æ—Ö—Ä–∞–Ω—è–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–π —Å–µ–±–µ –æ –Ω—ë–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ü–µ–Ω.`
    : psychContract
      ? `–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏—Å—Ç–æ—Ä–∏–∏: ¬´${psychContract.question}¬ª. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.`
      : `–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏—Å—Ç–æ—Ä–∏–∏ –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`;

  return `${buildInputDataBlock(author.genre, arcLimit)}
${psychContract ? buildPsychologicalContractInfo(psychContract, psychScenario) : ''}

üîπ –ü–†–û–ú–ü–¢ (—è–¥—Ä–æ –¥–ª—è –º–æ–¥–µ–ª–∏)

–°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
–û—Å–Ω–æ–≤—ã–≤–∞–π —Ç–µ–º—É –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–∞—Å—Ç–∏:
chart_analysis –ø–æ–¥–∫–ª—é—á—ë–Ω –≤—ã—à–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –º–æ—Ç–∏–≤—ã –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è.
–ê–≤—Ç–æ—Ä—Å–∫–∏–π —Å—Ç–∏–ª—å: ${author.stylePrompt}

–ì–µ—Ä–æ–∏–Ω—è ‚Äî –∂–µ–Ω—â–∏–Ω–∞, –∏–º—è –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è.
–ü–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–µ–¥—ë—Ç—Å—è –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ –ª–∏—Ü–∞ (¬´—Ç—ã¬ª).
${psychContract ? `\n–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç: ¬´${psychContract.question}¬ª\n–ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –ø–æ–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫ –≥–µ—Ä–æ–∏–Ω—è —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è —Å —Ç–∏–ø–∏—á–Ω—ã–º–∏ –ª–æ–≤—É—à–∫–∞–º–∏ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (—Å–º. –≤—ã—à–µ).` : ''}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ù–ï–¢ –ú–ò–°–¢–ò–ö–ò:
- –ê–ë–°–û–õ–Æ–¢–ù–û –ó–ê–ü–†–ï–©–ï–ù–û: –ª—é–±–∞—è –º–∏—Å—Ç–∏–∫–∞, –º–∞–≥–∏—è, —Å–∏–º–≤–æ–ª–∏–∑–º, –º–µ—Ç–∞—Ñ–æ—Ä—ã, –∑–∞–≥–∞–¥–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞
- –ù–ï–¢ —Å–ª–æ–≤: "–º–∏—Å—Ç–∏–∫–∞", "—Ç–∞–π–Ω–∞", "–∑–∞–≥–∞–¥–∫–∞", "—Å–∏–º–≤–æ–ª", "–∑–Ω–∞–∫", "—Å—É–¥—å–±–∞"
- –¢–û–õ–¨–ö–û –†–ï–ê–õ–¨–ù–ê–Ø –ñ–ò–ó–ù–¨: –æ–±—ã—á–Ω—ã–µ –±—É–¥–Ω–∏, –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏, —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞: –æ—Ñ–∏—Å, –∫–≤–∞—Ä—Ç–∏—Ä–∞, –∫–∞—Ñ–µ, –ø–∞—Ä–∫, –¥–æ–º —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –º–∞–≥–∞–∑–∏–Ω, —Å–ø–æ—Ä—Ç–∑–∞–ª
- –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ –ª—é–¥–∏: –Ω–∞—á–∞–ª—å–Ω–∏–∫, –º–∞–º–∞, –ø–æ–¥—Ä—É–≥–∞, –ø–∞—Ä—Ç–Ω—ë—Ä, –∫–æ–ª–ª–µ–≥–∏, —Å–æ—Å–µ–¥–∏
- –¢–û–õ–¨–ö–û –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏: —Ä–∞–±–æ—Ç–∞, —Å–µ–º—å—è, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –¥—Ä—É–∂–±–∞, –±—ã—Ç
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è, –∞ –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
- –ñ–∞–Ω—Ä: –í–°–ï–ì–î–ê "—Ä–µ–∞–ª–∏–∑–º" –∏–ª–∏ "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –¥—Ä–∞–º–∞", –ù–ï "–º–∏—Å—Ç–∏–∫–∞"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ï–í–†–û–ü–ï–ô–°–ö–ò–ô –ö–û–ù–¢–ï–ö–°–¢:
- –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≥–¥–µ-—Ç–æ –≤ –ï–≤—Ä–æ–ø–µ (–Ω–µ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω—É)
- –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
  ‚ùå –†–æ—Å—Å–∏–π—Å–∫–∏–µ –≥–æ—Ä–æ–¥–∞ (–ú–æ—Å–∫–≤–∞, –ü–∏—Ç–µ—Ä, –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ –∏ —Ç.–¥.)
  ‚ùå –†–æ—Å—Å–∏–π—Å–∫–∏–µ —É–ª–∏—Ü—ã, —Ä–∞–π–æ–Ω—ã, —Ç–æ–ø–æ–Ω–∏–º—ã
  ‚ùå –†—É–±–ª–∏, —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –±—Ä–µ–Ω–¥—ã
  ‚ùå –¢–∏–ø–∏—á–Ω–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ä–µ–∞–ª–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ —Ä–µ–∞–ª–∏–∏:
  ‚úÖ –ï–≤—Ä–æ –∫–∞–∫ –≤–∞–ª—é—Ç–∞ (–∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –¥–µ–Ω—å–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)
  ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è: "—Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞", "—Å—Ç–∞—Ä—ã–π —Ä–∞–π–æ–Ω", "–Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è"
  ‚úÖ –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –º–µ—Å—Ç: –∫–∞—Ñ–µ, –æ—Ñ–∏—Å, –ø–∞—Ä–∫ (–±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π)

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ò–ú–ï–ù–ê –ü–ï–†–°–û–ù–ê–ñ–ï–ô:
- –ê–ë–°–û–õ–Æ–¢–ù–û –ó–ê–ü–†–ï–©–ï–ù–´ –º—É–∂—Å–∫–∏–µ –∏–º–µ–Ω–∞: –ò–≥–æ—Ä—å, –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω, –°—Ç–∞—Å
- –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–≥–∏–µ –∏–º–µ–Ω–∞: –ú–∞–∫—Å–∏–º, –î–µ–Ω–∏—Å, –ê—Ä—Ç—ë–º, –ê–ª–µ–∫—Å, –ú–∞—Ä–∫, –î–∏–º–∞, –ê–Ω–¥—Ä–µ–π, –†–æ–º–∞–Ω
- –î–ª—è –∂–µ–Ω—â–∏–Ω: –õ–µ–Ω–∞, –ö–∞—Ç—è, –ú–∞—à–∞, –ê–Ω—è, –°–æ–Ω—è, –í–∏–∫–∞, –û–ª—è, –ò—Ä–∞ (–ª—é–±—ã–µ, –∫—Ä–æ–º–µ –ù–∞—Å—Ç—è)

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ï–î–ò–ù–°–¢–í–û –ò–°–¢–û–†–ò–ò:
- –≠—Ç–æ –û–î–ù–ê —Ä–∞–∑–≤–∏–≤–∞—é—â–∞—è—Å—è –∏—Å—Ç–æ—Ä–∏—è, –∞ –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã
- –ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è —Å—Ü–µ–Ω–∞ ‚Äî –ø—Ä—è–º–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π
- –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï–• –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Å—Ü–µ–Ω (–∏–º–µ–Ω–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä—ã, –æ—Ç–Ω–æ—à–µ–Ω–∏—è)
- –ú–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è, –Ω–æ –ª–æ–≥–∏—á–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ –∫—É—Ö–Ω–µ ‚Üí –ø–æ—Ç–æ–º –≤ —Å–≤–æ–µ–π –∫–æ–º–Ω–∞—Ç–µ –≤ —Ç–æ–º –∂–µ –¥–æ–º–µ)
- –°–æ–±—ã—Ç–∏—è —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ: –µ—Å–ª–∏ –≥–µ—Ä–æ–π —Å–∫–∞–∑–∞–ª –ê –≤ —Å—Ü–µ–Ω–µ 1, –≤ —Å—Ü–µ–Ω–µ 2 –æ–Ω –ø–æ–º–Ω–∏—Ç –æ–± —ç—Ç–æ–º
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è: —É—Å—Ç–∞–ª–æ—Å—Ç—å, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –æ–±–ª–µ–≥—á–µ–Ω–∏–µ

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏:
1. –ó–∞–≤—è–∑–∫–∞ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è —Å –ø–æ–Ω—è—Ç–Ω–æ–π –¥–∏–ª–µ–º–º–æ–π
2. –û–±–æ—Å—Ç—Ä–µ–Ω–∏–µ ‚Äî –¥–∞–≤–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤
3. –í—ã–±–æ—Ä ‚Äî –≥–µ—Ä–æ–∏–Ω—è –≤—ã–±–∏—Ä–∞–µ—Ç: –ø—Ä–∏–≤—ã—á–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É
4. –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è ‚Äî —Ä–µ–∞–∫—Ü–∏–∏ –ª—é–¥–µ–π, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞, —Ü–µ–Ω–∞ —Ä–µ—à–µ–Ω–∏—è
5. –ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è ‚Äî —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω—ã–º —Å—Ç—Ä–∞—Ö–æ–º —ç—Ç–æ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
6. –†–∞–∑–≤—è–∑–∫–∞ ‚Äî —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, —á—Ç–æ –ø–æ–Ω—è–ª–∞, —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥

–°–µ–π—á–∞—Å –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —É–∑–µ–ª ${currentArc} –∏–∑ ${arcLimit} ‚Äî ¬´${stage}¬ª.
${currentArc === arcLimit ? `\n‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ —É–∑–µ–ª ${currentArc}, –ù–û –≠–¢–û –ï–©–Å –ù–ï –§–ò–ù–ê–õ –∏—Å—Ç–æ—Ä–∏–∏!\n–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —É–∑–ª–∞ –±—É–¥–µ—Ç –µ—â—ë –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ —Å —Ä–∞–∑–≤—è–∑–∫–æ–π –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π.\n–¢–≤–æ—è –∑–∞–¥–∞—á–∞ –∑–¥–µ—Å—å: —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ü–µ–Ω—É –∏ –¥–∞—Ç—å –≥–µ—Ä–æ–∏–Ω–µ –ü–û–°–õ–ï–î–ù–ò–ô –≤—ã–±–æ—Ä.\n–ù–ï –∑–∞–≤–µ—Ä—à–∞–π –∏—Å—Ç–æ—Ä–∏—é, –ù–ï –ø–∏—à–∏ —Ä–∞–∑–≤—è–∑–∫—É ‚Äî —Ç–æ–ª—å–∫–æ –µ—â—ë –æ–¥–Ω—É —Å—Ü–µ–Ω—É —Å –≤—ã–±–æ—Ä–æ–º!\n` : ''}
–§–æ–∫—É—Å —ç—Ç–æ–≥–æ —É–∑–ª–∞: ${stageGuidance}
${currentArc === 1 && psychScenario ? `–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (—Å–º. –≤—ã—à–µ –≤ –±–ª–æ–∫–µ "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç"). –°–æ–∑–¥–∞–π —Å—Ü–µ–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî —ç—Ç–æ –†–ï–ê–õ–¨–ù–û–ï –º–µ—Å—Ç–æ, –†–ï–ê–õ–¨–ù–ê–Ø —Å–∏—Ç—É–∞—Ü–∏—è.` : ''}
${choiceInstruction}
${contractInstruction}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ (–ø—Ä–æ—á–∏—Ç–∞–π –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û, —ç—Ç–æ —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è):
${storyContext}

–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–†–û–î–û–õ–ñ–ï–ù–ò–Æ:
${currentArc > 1 ? `
1. –ü–µ—Ä–µ—á–∏—Ç–∞–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ü–µ–Ω—ã –≤—ã—à–µ
2. –ù–∞–π–¥–∏ –∏–º–µ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –º–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è, –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã
3. –¢–≤–æ—è –Ω–æ–≤–∞—è —Å—Ü–µ–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–±–æ—Ä–∞
4. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ –∂–µ –∏–º–µ–Ω–∞, –µ—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω—ã
5. –ü–æ–∫–∞–∂–∏ –ø—Ä—è–º—É—é –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—É—é —Å–≤—è–∑—å: –≤—ã–±–æ—Ä ‚Üí –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ
6. –ï—Å–ª–∏ –≥–µ—Ä–æ–π –≤—ã–±—Ä–∞–ª "—Å–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–¥—É", –ø–æ–∫–∞–∂–∏ –ö–ê–ö –æ–Ω —ç—Ç–æ —Å–∫–∞–∑–∞–ª –∏ —á—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª–∏
7. –ï—Å–ª–∏ –≥–µ—Ä–æ–π –≤—ã–±—Ä–∞–ª "–ø—Ä–æ–º–æ–ª—á–∞—Ç—å", –ø–æ–∫–∞–∂–∏ –ö–ê–ö –æ–Ω –ø—Ä–æ–º–æ–ª—á–∞–ª –∏ —á—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –≤—ã—à–ª–æ
` : ''}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ü–µ–Ω–µ:
- –æ–¥–∏–Ω –∞–±–∑–∞—Ü –∏–∑ 3‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (55‚Äì85 —Å–ª–æ–≤);
- –ö–û–ù–ö–†–ï–¢–ò–ö–ê: –Ω–∞–∑—ã–≤–∞–π –º–µ—Å—Ç–∞, –¥–µ–π—Å—Ç–≤–∏—è, —Å–ª–æ–≤–∞ –ª—é–¥–µ–π;
- –†–ï–ê–õ–ò–ó–ú: –≤—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–∑–Ω–∞–≤–∞–µ–º–æ –∏–∑ –æ–±—ã—á–Ω–æ–π –∂–∏–∑–Ω–∏;
- –∏—Å–ø–æ–ª—å–∑—É–π –º–æ—Ç–∏–≤—ã –∏–∑ chart_analysis, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–π –∏—Ö —á–µ—Ä–µ–∑ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∞ –Ω–µ —Å–∏–º–≤–æ–ª—ã;
- –∑–∞–≤–µ—Ä—à–∞–π –æ—â—É—â–µ–Ω–∏–µ–º –≤—ã–±–æ—Ä–∞.

–ü–æ—Å–ª–µ —Å—Ü–µ–Ω—ã –ø–æ–¥–≥–æ—Ç–æ–≤—å –¥–≤–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤—ã–±–æ—Ä–∞ (–±–µ–∑ –∫–ª–∏—à–µ ¬´–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª):
- title ‚Äî –¥–æ 32 —Å–∏–º–≤–æ–ª–æ–≤;
- description ‚Äî –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ 90 —Å–∏–º–≤–æ–ª–æ–≤.

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "meta": {
    "author": "${author.name}",
    "title": "–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (2-3 —Å–ª–æ–≤–∞, –æ—Ç—Ä–∞–∂–∞—é—â–∏—Ö —Å—É—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞)",
    "genre": "—Ä–µ–∞–ª–∏–∑–º",
    "contract": "—Å—Ç—Ä–æ–∫–∞"${currentArc === 1 ? `,
    "moon_summary": "–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –õ—É–Ω—ã (–°–¢–†–û–ì–û –Ω–µ –±–æ–ª—å—à–µ 300 —Å–∏–º–≤–æ–ª–æ–≤!), –∫–æ—Ç–æ—Ä–æ–µ –û–ë–†–ê–©–ê–ï–¢–°–Ø –ö –ù–ê–°–¢–ï –Ω–∞–ø—Ä—è–º—É—é. –õ—É–Ω–∞ –∫–∞–∫ –±—ã '–∑–∞–º–µ—á–∞–µ—Ç', —á—Ç–æ –ù–∞—Å—Ç—è —á–∏—Ç–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –ø–ª–∞–Ω–µ—Ç, –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è —Å –æ–±—Å—É–∂–¥–µ–Ω–∏—è –≤ 3-–º –ª–∏—Ü–µ –Ω–∞ –ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –æ–±—Ä–∞—â–µ–Ω–∏—è —Ç–∏–ø–∞ '–ù–∞—Å—Ç—è, —Ç—ã –∂–µ –Ω–∞—Å —Ç—É—Ç —á–∏—Ç–∞–µ—à—å?' –∏–ª–∏ '–û, –ù–∞—Å—Ç—è, –ø—Ä–∏–≤–µ—Ç! –í–∏–¥–∏—à—å, —á—Ç–æ –º—ã —Ç—É—Ç –æ–±—Å—É–∂–¥–∞–µ–º?'. –ó–∞—Ç–µ–º –ü–†–û–°–¢–´–ú –Ø–ó–´–ö–û–ú (–ë–ï–ó –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ —Ç–∏–ø–∞ '–∫–≤–∞–¥—Ä–∞—Ç', '–æ–ø–ø–æ–∑–∏—Ü–∏—è', '—Ç—Ä–∏–Ω'!) –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω—è–µ—Ç, —á—Ç–æ –æ–±—Å—É–¥–∏–ª–∏ –∏ –ø–æ—á–µ–º—É. –û–±—ä—è—Å–Ω—è–µ—Ç –≤–ª–∏—è–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç —á–µ—Ä–µ–∑ –±—ã—Ç–æ–≤—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. –°—Ç–∏–ª—å: —Ç—ë–ø–ª—ã–π, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º. –ü—Ä–∏–º–µ—Ä: '–ù–∞—Å—Ç—è, —Ç—ã –Ω–∞—Å —Ç—É—Ç –ø–æ–¥—Å–ª—É—à–∏–≤–∞–µ—à—å? –õ–∞–¥–Ω–æ, –∫–æ—Ä–æ—á–µ: –æ–±—Å—É–¥–∏–ª–∏ —Ç–≤–æ—é –∫–∞—Ä—Ç—É. –°–∞—Ç—É—Ä–Ω —Ç–≤–µ—Ä–¥–∏—Ç, —á—Ç–æ —Ç—ã —ç–º–æ—Ü–∏–∏ –ø—Ä—è—á–µ—à—å. –ü–ª—É—Ç–æ–Ω —Å –í–µ–Ω–µ—Ä–æ–π —Ç—è–Ω—É—Ç —Ç–µ–±—è –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî —Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª—å, —Ç–æ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ. –†–µ—à–∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ –≤—ã–±–æ—Ä: –æ—Ç–∫—Ä—ã—Ç—å—Å—è –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç—å—Å—è. –ü–æ—Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ –≤—ã–±–µ—Ä–µ—à—å?'"` : ''},
    "arc_limit": ${arcLimit}
  },
  "node": {
    "arc": ${currentArc},
    "stage": "${stage}",
    "scene": "–∞–±–∑–∞—Ü –∏—Å—Ç–æ—Ä–∏–∏"
  },
  "choices": [
    { "id": "—É–Ω–∏–∫–∞–ª—å–Ω—ã–π-kebab-case", "title": "‚Ä¶", "description": "‚Ä¶" },
    { "id": "—É–Ω–∏–∫–∞–ª—å–Ω—ã–π-kebab-case", "title": "‚Ä¶", "description": "‚Ä¶" }
  ]
}

–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, Markdown –∏ —ç–º–æ–¥–∑–∏.`;
}

interface FinalePromptArgs {
  segments: HistoryStoryContextSegment[];
  currentChoice?: HistoryStoryOption;
  summary?: string;
  author: HistoryStoryAuthorStyle;
  arcLimit: number;
  contract?: string;
}

function buildFinalePrompt(args: FinalePromptArgs, psychContext?: PsychContractContext): string {
  const {
    segments,
    currentChoice,
    summary,
    author,
    arcLimit,
    contract,
  } = args;

  const storyContext = buildStorySoFar(segments, arcLimit, summary);

  const choiceInstruction = currentChoice
    ? `–≠—Ç–æ –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–±–æ—Ä –ù–∞—Å—Ç–∏: ¬´${currentChoice.title}¬ª${
        currentChoice.description ? ` (${currentChoice.description})` : ''
      }. –ü–æ—Å—Ç—Ä–æ–π —Ä–∞–∑–≤—è–∑–∫—É –∫–∞–∫ –ø—Ä—è–º–æ–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞.`
    : '–°—á–∏—Ç–∞–π, —á—Ç–æ –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω –≤ –ø–æ–ª—å–∑—É —è—Å–Ω–æ—Å—Ç–∏ ‚Äî –ø–æ–∫–∞–∂–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.';

  const contractInstruction = contract
    ? `–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏—Å—Ç–æ—Ä–∏–∏: ¬´${contract}¬ª. –ü—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –µ–≥–æ —Ç–æ–Ω–∞ –≤ —Ä–∞–∑–≤—è–∑–∫–µ.`
    : '–°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–±–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—è–≤–∏—Ç—å—Å—è –≤ –≤—ã–≤–æ–¥–∞—Ö —Ñ–∏–Ω–∞–ª–∞.';

  return `${buildInputDataBlock(author.genre, arcLimit)}
${psychContext ? `${buildPsychologicalContractInfo(psychContext.contract)}\n` : ''}

üîπ –ü–†–û–ú–ü–¢ (—è–¥—Ä–æ –¥–ª—è –º–æ–¥–µ–ª–∏)

–¢—ã –∑–∞–≤–µ—Ä—à–∏—à—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ù–∞—Å—Ç–∏.
${contractInstruction}
${choiceInstruction}
–£–¥–µ—Ä–∂–∏–≤–∞–π –∞–≤—Ç–æ—Ä—Å–∫–∏–π —Å—Ç–∏–ª—å: ${author.stylePrompt}

–í–ê–ñ–ù–û: –§–∏–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–ú –∏ –ñ–ò–ó–ù–ï–ù–ù–´–ú:
- –ù–ò–ö–ê–ö–û–ô –º–∏—Å—Ç–∏–∫–∏, –º–µ—Ç–∞—Ñ–æ—Ä, —Å–∏–º–≤–æ–ª–æ–≤
- –ü–æ–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é –≥–µ—Ä–æ–∏–Ω–∏ –∏ –æ–∫—Ä—É–∂–∞—é—â–∏—Ö
- –û–ø–∏—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞ –∏ –º—ã—Å–ª–∏
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∞ –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ï–í–†–û–ü–ï–ô–°–ö–ò–ô –ö–û–ù–¢–ï–ö–°–¢:
- –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≥–¥–µ-—Ç–æ –≤ –ï–≤—Ä–æ–ø–µ (–Ω–µ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω—É)
- –ó–ê–ü–†–ï–©–ï–ù–û: —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –≥–æ—Ä–æ–¥–∞, —É–ª–∏—Ü—ã, —Ä—É–±–ª–∏, —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ä–µ–∞–ª–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ —Ä–µ–∞–ª–∏–∏: –µ–≤—Ä–æ (–∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –¥–µ–Ω—å–≥–∏), —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—Ç

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ò–ú–ï–ù–ê –ü–ï–†–°–û–ù–ê–ñ–ï–ô:
- –ê–ë–°–û–õ–Æ–¢–ù–û –ó–ê–ü–†–ï–©–ï–ù–´ –º—É–∂—Å–∫–∏–µ –∏–º–µ–Ω–∞: –ò–≥–æ—Ä—å, –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω, –°—Ç–∞—Å
- –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—à—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∏—Å–ø–æ–ª—å–∑—É–π –∏–º–µ–Ω–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å—Ü–µ–Ω –∏–ª–∏ –¥—Ä—É–≥–∏–µ: –ú–∞–∫—Å–∏–º, –î–µ–Ω–∏—Å, –ê—Ä—Ç—ë–º, –ê–ª–µ–∫—Å, –ú–∞—Ä–∫

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏:
${storyContext}

–°—Ñ–æ—Ä–º–∏—Ä—É–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫:
- resolution ‚Äî –æ–¥–∏–Ω –∞–±–∑–∞—Ü –∏–∑ 3‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (60‚Äì90 —Å–ª–æ–≤), –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å—é–∂–µ—Ç —á–µ—Ä–µ–∑ –ö–û–ù–ö–†–ï–¢–ù–´–ï –¥–µ–π—Å—Ç–≤–∏—è –∏ —Å–ª–æ–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –≤—ã–±–æ—Ä–∞ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ;

- human_interpretation ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º —è–∑—ã–∫–µ (4‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) —Å –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ú –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º:
  1. –ü–û–ß–ï–ú–£ —Ç—ã —Å–¥–µ–ª–∞–ª–∞ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∏–µ –≤—ã–±–æ—Ä—ã –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–∞—Ö ‚Äî –æ–±—ä—è—Å–Ω–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é —á–µ—Ä–µ–∑ —á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
  2. –ö–∞–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–≤–æ–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ—è–≤–∏–ª–∏—Å—å –≤ —ç—Ç–∏—Ö —Ä–µ—à–µ–Ω–∏—è—Ö (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å, –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ, –∫–æ–Ω—Ç—Ä–æ–ª—å, –∏–Ω—Ç—É–∏—Ü–∏—è)
  3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –æ—Ü–µ–Ω–∏: –±—ã–ª–∏ –ª–∏ –≤—ã–±–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Å–≤–æ–π—Å—Ç–≤–µ–Ω–Ω—ã —Ç–≤–æ–µ–º—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É? –ì–¥–µ —Ç—ã –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∞ –≤–æ–ø—Ä–µ–∫–∏ —Å–≤–æ–µ–π –ø—Ä–∏—Ä–æ–¥–µ?
  4. –£–∫–∞–∂–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–æ–±—ã—á–Ω–æ —Ç—ã –æ—Å—Ç–æ—Ä–æ–∂–Ω–∞, –Ω–æ –∑–¥–µ—Å—å –±—Ä–æ—Å–∏–ª–∞—Å—å –≤ —Ä–∏—Å–∫")
  5. –ï–°–õ–ò –≤—ã–±–æ—Ä –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å: –º–æ–∂–µ—Ç –±—ã—Ç—å, —Ç—ã –æ—Ç–≤–µ—á–∞–ª–∞ –Ω–µ —á–µ—Å—Ç–Ω–æ, –∞ "–∫–∞–∫ –Ω–∞–¥–æ"? –ú–æ–∂–µ—Ç, –±–æ—è–ª–∞—Å—å –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–∏–Ω–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é? –õ—é–¥–∏ —á–∞—Å—Ç–æ –≤—ã–±–∏—Ä–∞—é—Ç —Å–æ—Ü–∏–∞–ª—å–Ω–æ-–æ–¥–æ–±—Ä—è–µ–º—ã–π –æ—Ç–≤–µ—Ç –≤–º–µ—Å—Ç–æ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ.
  6. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã (–±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–ª–∞–Ω–µ—Ç, –¥–æ–º–æ–≤, –∞—Å–ø–µ–∫—Ç–æ–≤)
  7. –ë—É–¥—å —á–µ—Å—Ç–Ω–æ–π ‚Äî –Ω–µ –Ω–∞—Ç—è–≥–∏–≤–∞–π –æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –≤—ã–±–æ—Ä –Ω–µ —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –ª–æ–≥–∏–∫—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞

  –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: "–¢–≤–æ–π –≤—ã–±–æ—Ä —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏—Ä–æ–¥–Ω—É—é –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ —è–≤–Ω–æ —Å–≤–æ–π—Å—Ç–≤–µ–Ω–Ω–æ —Ç–µ–±–µ. –ù–æ –Ω–∞ —Ç—Ä–µ—Ç—å–µ–º —ç—Ç–∞–ø–µ —Ç—ã –≤—ã–±—Ä–∞–ª–∞ '—Å–º–µ–ª–æ –ø–æ–π—Ç–∏ –Ω–∞–≤—Å—Ç—Ä–µ—á—É' ‚Äî —ç—Ç–æ –ù–ï —Ç–∏–ø–∏—á–Ω–æ –¥–ª—è —Ç–≤–æ–µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞. –í–æ–∑–º–æ–∂–Ω–æ, –∑–¥–µ—Å—å —Å—ã–≥—Ä–∞–ª–∞ —Ä–æ–ª—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –±–æ—Ä—å–±–∞, –∞ –º–æ–∂–µ—Ç, —Ç—ã –æ—Ç–≤–µ—Ç–∏–ª–∞ —Ç–∞–∫, –∫–∞–∫ '–ø—Ä–∞–≤–∏–ª—å–Ω–æ', –∫–∞–∫ –æ—Ç —Ç–µ–±—è –æ–∂–∏–¥–∞—é—Ç ‚Äî –≤—ã–±—Ä–∞–ª–∞ —Å–º–µ–ª–æ—Å—Ç—å –Ω–µ –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–∫ —á—É–≤—Å—Ç–≤—É–µ—à—å, –∞ –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–∫ '–Ω–∞–¥–æ'. –ù–∞ –ø—è—Ç–æ–º —ç—Ç–∞–ø–µ —Ç—ã –≤–µ—Ä–Ω—É–ª–∞—Å—å –∫ –ø—Ä–∏–≤—ã—á–Ω–æ–π –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî –ø–æ—Ö–æ–∂–µ, –∏—Å—Ç–∏–Ω–Ω–∞—è –ø—Ä–∏—Ä–æ–¥–∞ –≤–∑—è–ª–∞ —Å–≤–æ—ë. –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ: –≥–¥–µ –≤ —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞—Å—Ç–æ—è—â–∞—è —Ç—ã, –∞ –≥–¥–µ ‚Äî –∂–µ–ª–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑—É?"

- astrological_interpretation ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (4‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) —Å –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ú –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º:
  1. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã, –∑–Ω–∞–∫–∏ –∏ –¥–æ–º–∞ –∏–∑ chart_analysis (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–°–æ–ª–Ω—Ü–µ –≤ –ë–ª–∏–∑–Ω–µ—Ü–∞—Ö –≤ 5-–º –¥–æ–º–µ", "–õ—É–Ω–∞ –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ —Å –°–∞—Ç—É—Ä–Ω–æ–º")
  2. –ü–û–ß–ï–ú–£ —Ç—ã —Å–¥–µ–ª–∞–ª–∞ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∏–µ –≤—ã–±–æ—Ä—ã –Ω–∞ –∫–∞–∂–¥–æ–º –∏–∑ 6 —ç—Ç–∞–ø–æ–≤ ‚Äî –æ–±—ä—è—Å–Ω–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é —á–µ—Ä–µ–∑ –ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç –∏ –∞—Å–ø–µ–∫—Ç—ã
  3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –æ—Ü–µ–Ω–∏: –±—ã–ª–∏ –ª–∏ –≤—ã–±–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ü–†–û–¢–ò–í–û–†–ï–ß–ê–¢ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ? –ì–¥–µ –∫–∞—Ä—Ç–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–ª–∞ –æ–¥–Ω–æ, –∞ —Ç—ã —Å–¥–µ–ª–∞–ª–∞ –¥—Ä—É–≥–æ–µ?
  4. –û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è —á–µ—Ä–µ–∑ –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã (–∫–≤–∞–¥—Ä–∞—Ç—ã, –æ–ø–ø–æ–∑–∏—Ü–∏–∏) ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –±–æ—Ä—å–±–∞ –ø–ª–∞–Ω–µ—Ç
  5. –ï–°–õ–ò –≤—ã–±–æ—Ä –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –∫–∞—Ä—Ç–µ –∏ –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è –∞—Å–ø–µ–∫—Ç–∞–º–∏, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏: –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ —Å–æ—Ü–∏–∞–ª—å–Ω–æ-–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –∞ –Ω–µ –∏—Å—Ç–∏–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è? –ö–∞—Ä—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç–æ—è—â—É—é –ø—Ä–∏—Ä–æ–¥—É, –∞ –≤—ã–±–æ—Ä ‚Äî —Ç–æ, —á—Ç–æ —á–µ–ª–æ–≤–µ–∫ —Ö–æ—á–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å.
  6. –ù–µ –Ω–∞—Ç—è–≥–∏–≤–∞–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é ‚Äî –µ—Å–ª–∏ –≤—ã–±–æ—Ä –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è –∫–∞—Ä—Ç–æ–π, —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
  7. –ò—Å–ø–æ–ª—å–∑—É–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã, –ù–û –æ–±—ä—è—Å–Ω—è–π –∏—Ö –≤–ª–∏—è–Ω–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º –≤ —Å–∫–æ–±–∫–∞—Ö

  –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: "–¢–≤–æ–π –≤—ã–±–æ—Ä —É–π—Ç–∏ –≤ —Ç–µ–Ω—å –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ –ª–æ–≥–∏—á–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è –õ—É–Ω–æ–π –≤ 12-–º –¥–æ–º–µ (–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —É–µ–¥–∏–Ω–µ–Ω–∏–∏ –∏ –∑–∞—â–∏—Ç–µ). –ö–≤–∞–¥—Ä–∞—Ç –°–∞—Ç—É—Ä–Ω–∞ –∫ –õ—É–Ω–µ –¥–æ–±–∞–≤–∏–ª —Å—Ç—Ä–∞—Ö–∞ –ø–µ—Ä–µ–¥ –æ—à–∏–±–∫–æ–π. –ù–æ –Ω–∞ —Ç—Ä–µ—Ç—å–µ–º —ç—Ç–∞–ø–µ —Ç—ã —Ä–µ–∑–∫–æ –≤—ã–±—Ä–∞–ª–∞ '–ø–æ–π—Ç–∏ —Å–º–µ–ª–æ –≤–ø–µ—Ä—ë–¥' ‚Äî —ç—Ç–æ –ü–†–û–¢–ò–í–û–†–ï–ß–ò–¢ –∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ–π –õ—É–Ω–µ, –∏ –º–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ–º—É –ú–∞—Ä—Å—É –≤ –¢–µ–ª—å—Ü–µ. –£ —Ç–µ–±—è –Ω–µ—Ç –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ (–£—Ä–∞–Ω, –ú–∞—Ä—Å –≤ –æ–≥–Ω–µ), –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä—è—Å–Ω—è–ª–∏ –±—ã —Ç–∞–∫–æ–π –≤—ã–±–æ—Ä. –í–æ–∑–º–æ–∂–Ω–æ, —Ç—ã –≤—ã–±—Ä–∞–ª–∞ –Ω–µ —Ç–æ, —á—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—à—å, –∞ —Ç–æ, —á—Ç–æ —Å—á–∏—Ç–∞–µ—à—å '–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º' ‚Äî —Å–æ—Ü–∏–∞–ª—å–Ω–æ –æ–¥–æ–±—Ä—è–µ–º—É—é —Å–º–µ–ª–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ —á–µ—Å—Ç–Ω–æ–π –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏. –ù–∞ –ø—è—Ç–æ–º —ç—Ç–∞–ø–µ —Ç—ã –≤–µ—Ä–Ω—É–ª–∞—Å—å –∫ –ø–∞—Ç—Ç–µ—Ä–Ω—É –°–∞—Ç—É—Ä–Ω–∞-–õ—É–Ω—ã (–∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –∑–∞—â–∏—Ç–∞) ‚Äî –≤–æ—Ç –æ–Ω–∞, –Ω–∞—Å—Ç–æ—è—â–∞—è —Ä–µ–∞–∫—Ü–∏—è. –ö–∞—Ä—Ç–∞ –Ω–µ –≤—Ä—ë—Ç: —Ç–≤–æ—è –ø—Ä–∏—Ä–æ–¥–∞ ‚Äî —ç—Ç–æ –≤–¥—É–º—á–∏–≤–æ—Å—Ç—å, –Ω–µ –∏–º–ø—É–ª—å—Å."

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
1. –ö–∞–∂–¥–æ–µ –ø–æ–ª–µ JSON –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –û–î–ù–£ —Å—Ç—Ä–æ–∫—É –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ (\\n).
2. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
3. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–±–µ–ª—ã –≤–º–µ—Å—Ç–æ –ª—é–±—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤.
4. –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è "resolution", "human_interpretation" –∏ "astrological_interpretation" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.

–°–æ—Ö—Ä–∞–Ω—è–π –≤—Ç–æ—Ä–æ–µ –ª–∏—Ü–æ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ—Å—Ç—å, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã—Ö —Ä–∞–∑–≤–∏–ª–æ–∫.

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–ø—Ä–∏–º–µ—Ä):
{"meta":{"author":"${author.name}","title":"–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (2-3 —Å–ª–æ–≤–∞)","genre":"—Ä–µ–∞–ª–∏–∑–º","contract":"—Å—Ç—Ä–æ–∫–∞","arc_limit":${arcLimit}},"finale":{"resolution":"–∞–±–∑–∞—Ü-—Ä–∞–∑–≤—è–∑–∫–∞ –≤ –æ–¥–Ω—É –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤","human_interpretation":"4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –æ–¥–Ω—É –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É: –∞–Ω–∞–ª–∏–∑ –≤—ã–±–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ —á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –±–µ–∑ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤","astrological_interpretation":"4-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –æ–¥–Ω—É –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É: –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—ã–±–æ—Ä–æ–≤ —Å –ø–ª–∞–Ω–µ—Ç–∞–º–∏, –¥–æ–º–∞–º–∏ –∏ –∞—Å–ø–µ–∫—Ç–∞–º–∏"}}

–ù–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π JSON –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –∏–ª–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏ (–Ω–æ –Ω–µ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π).`;
}

function sanitizeOption(
  option: Partial<HistoryStoryOption> | undefined,
  fallback: HistoryStoryOption,
): HistoryStoryOption {
  if (!option) {
    return fallback;
  }

  const id = typeof option.id === 'string' && option.id.trim().length > 0
    ? option.id.trim()
    : fallback.id;

  const title = typeof option.title === 'string' && option.title.trim().length > 0
    ? option.title.trim().slice(0, 48)
    : fallback.title;

  const description = typeof option.description === 'string' && option.description.trim().length > 0
    ? option.description.trim().slice(0, 140)
    : fallback.description;

  return { id, title, description };
}

interface NormalizeOptions {
  mode: 'arc' | 'finale';
  authorName: string;
  genre: string;
  arcLimit: number;
  currentArc: number;
  contract?: string;
}

function normalizeResponse(raw: unknown, options: NormalizeOptions): HistoryStoryResponse {
  const contract = options.contract ?? DEFAULT_CONTRACT;

  if (options.mode === 'finale') {
    const metaSource = (raw as any)?.meta;
    const finaleSource = (raw as any)?.finale ?? raw;

    const resolvedContract =
      typeof metaSource?.contract === 'string' && metaSource.contract.trim().length > 0
        ? metaSource.contract.trim()
        : contract;

    const resolution =
      typeof finaleSource?.resolution === 'string' && finaleSource.resolution.trim().length > 0
        ? finaleSource.resolution.trim()
        : '';

    const humanInterpretation =
      typeof finaleSource?.human_interpretation === 'string' && finaleSource.human_interpretation.trim().length > 0
        ? finaleSource.human_interpretation.trim()
        : typeof finaleSource?.interpretation === 'string' && finaleSource.interpretation.trim().length > 0
          ? finaleSource.interpretation.trim()
          : '';

    const astrologicalInterpretation =
      typeof finaleSource?.astrological_interpretation === 'string' && finaleSource.astrological_interpretation.trim().length > 0
        ? finaleSource.astrological_interpretation.trim()
        : '';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —á–∞—Å—Ç–∏ —Ñ–∏–Ω–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
    if (!resolution) {
      throw new Error('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ä–ª–∞ –≤ –ø—Ä–µ–¥–≤–∫—É—à–µ–Ω–∏–∏... üé≠ –ü–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞?');
    }
    if (!humanInterpretation) {
      throw new Error('–ü—Å–∏—Ö–æ–ª–æ–≥ –∑–∞–¥—É–º–∞–ª—Å—è —Å–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–æ ü§î –ï—â—ë —Ä–∞–∑–æ–∫?');
    }
    if (!astrologicalInterpretation) {
      throw new Error('–ü–ª–∞–Ω–µ—Ç—ã –≤—ã—Å—Ç—Ä–æ–∏–ª–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞ –∫–æ—Ñ–µ ‚òï‚ú® –ù–∞–∂–º–∏ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"!');
    }

    return {
      meta: {
        author: typeof metaSource?.author === 'string' && metaSource.author.trim().length > 0
          ? metaSource.author.trim()
          : options.authorName,
        title: typeof metaSource?.title === 'string' && metaSource.title.trim().length > 0
          ? metaSource.title.trim()
          : '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
        genre: '—Ä–µ–∞–ª–∏–∑–º', // –í—Å–µ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑–º, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç AI
        contract: resolvedContract,
        moonSummary: '', // –î–ª—è finale –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        arcLimit: Number.isFinite(metaSource?.arc_limit)
          ? Number(metaSource.arc_limit)
          : options.arcLimit,
      },
      options: [],
      finale: {
        resolution,
        humanInterpretation,
        astrologicalInterpretation,
      },
    };
  }

  const metaSource = (raw as any)?.meta ?? (raw as any);
  const nodeSource = (raw as any)?.node ?? (raw as any);
  const choicesSource = Array.isArray((raw as any)?.choices)
    ? (raw as any).choices
    : Array.isArray((raw as any)?.options)
      ? (raw as any).options
      : [];

  const resolvedContract =
    typeof metaSource?.contract === 'string' && metaSource.contract.trim().length > 0
      ? metaSource.contract.trim()
      : contract;

  const sceneText =
    typeof nodeSource?.scene === 'string' && nodeSource.scene.trim().length > 0
      ? nodeSource.scene.trim()
      : '';

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ü–µ–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞—è
  if (!sceneText) {
    throw new Error('–°—Ü–µ–Ω–∞ –∑–∞—Å—Ç—Ä—è–ª–∞ –º–µ–∂–¥—É —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—è–º–∏ üåÄ –î–∞–≤–∞–π –≤—ã—Ç–∞—â–∏–º –µ—ë –æ–±—Ä–∞—Ç–Ω–æ?');
  }

  const stageName =
    typeof nodeSource?.stage === 'string' && nodeSource.stage.trim().length > 0
      ? nodeSource.stage.trim()
      : getStageName(options.currentArc, options.arcLimit);

  const arcNumber = Number.isFinite(nodeSource?.arc)
    ? Math.max(1, Number(nodeSource.arc))
    : options.currentArc;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 2 –æ–ø—Ü–∏–∏
  if (!Array.isArray(choicesSource) || choicesSource.length < 2) {
    throw new Error('–†–∞–∑–≤–∏–ª–∫–∞ –¥–æ—Ä–æ–≥ –ø–æ—Ç–µ—Ä—è–ª–∞—Å—å –≤ —Ç—É–º–∞–Ω–µ üå´Ô∏è –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –µ—ë —Å–Ω–æ–≤–∞?');
  }

  const normalizedOptions: HistoryStoryOption[] = [
    sanitizeOption(choicesSource[0], FALLBACK_OPTIONS[0]),
    sanitizeOption(choicesSource[1], FALLBACK_OPTIONS[1]),
  ];

  return {
    meta: {
      author: typeof metaSource?.author === 'string' && metaSource.author.trim().length > 0
        ? metaSource.author.trim()
        : options.authorName,
      title: typeof metaSource?.title === 'string' && metaSource.title.trim().length > 0
        ? metaSource.title.trim()
        : '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
      genre: '—Ä–µ–∞–ª–∏–∑–º', // –í—Å–µ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑–º, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç AI
      contract: resolvedContract,
      moonSummary: typeof metaSource?.moon_summary === 'string' && metaSource.moon_summary.trim().length > 0
        ? metaSource.moon_summary.trim()
        : '', // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–≤–∞—è –¥—É–≥–∞ –∏–ª–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
      arcLimit: Number.isFinite(metaSource?.arc_limit)
        ? Number(metaSource.arc_limit)
        : options.arcLimit,
    },
    node: {
      arc: arcNumber,
      stage: stageName,
      scene: sceneText,
    },
    options: normalizedOptions,
  };
}

export async function generateHistoryStoryChunk({
  segments,
  currentChoice,
  summary,
  author,
  arcLimit,
  mode,
  currentArc,
  contract,
  signal,
  claudeApiKey,
  claudeProxyUrl,
  openAIApiKey,
  openAIProxyUrl,
}: HistoryStoryRequestOptions): Promise<HistoryStoryResponse> {
  const targetArc = mode === 'arc' ? (currentArc ?? 1) : arcLimit;
  let resolvedContract = contract;
  let psychContext: PsychContractContext | undefined;

  if (mode === 'arc') {
    if (targetArc === 1 && !contract) {
      psychContext = await ensurePsychContractContext(
        claudeApiKey,
        claudeProxyUrl,
        openAIApiKey,
        openAIProxyUrl,
      );
      resolvedContract = psychContext.contract.question;
    } else if (activePsychContext) {
      psychContext = activePsychContext;
      if (!resolvedContract) {
        resolvedContract = psychContext.contract.question;
      }
    }
  } else if (mode === 'finale' && activePsychContext) {
    psychContext = activePsychContext;
    if (!resolvedContract) {
      resolvedContract = psychContext.contract.question;
    }
  }

  const prompt =
    mode === 'finale'
      ? buildFinalePrompt(
          {
            segments,
            currentChoice,
            summary,
            author,
            arcLimit,
            contract: resolvedContract,
          },
          psychContext,
        )
      : buildArcPrompt(
          {
            segments,
            currentChoice,
            summary,
            author,
            arcLimit,
            currentArc: targetArc,
            contract: resolvedContract,
          },
          psychContext,
        );

  const messages: AIMessage[] = [
    {
      role: 'user',
      content: prompt,
    },
  ];

  try {
    const result = await callAI({
      system: `–¢—ã ${author.name}, —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–∞—è –ø–∏—Å–∞—Ç–µ–ª—å–Ω–∏—Ü–∞, —Å–æ–∑–¥–∞—é—â–∞—è –û–î–ù–£ —Å–≤—è–∑–Ω—É—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤–æ –≤—Ç–æ—Ä–æ–º –ª–∏—Ü–µ –¥–ª—è –ù–∞—Å—Ç–∏.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –≠—Ç–æ –û–î–ù–ê –∏—Å—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞
- –ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è —Å—Ü–µ–Ω–∞ ‚Äî –ø—Ä—è–º–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π
- –°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∏—Ö –∏–º–µ–Ω–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä—ã, —Å–∫–∞–∑–∞–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã
- –ü–æ–∫–∞–∑—ã–≤–∞–π –ø—Ä—è–º—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –≤—ã–±–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–µ –Ω–∞—á–∏–Ω–∞–π –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é

–°–æ–±–ª—é–¥–∞–π —Ñ–æ—Ä–º–∞—Ç JSON –±–µ–∑ Markdown –∏ –≤—ã–ø–æ–ª–Ω—è–π –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.`,
      messages,
      temperature: 0.85,
      maxTokens: mode === 'finale' ? 2000 : 1000, // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 600 –¥–æ 1000 –¥–ª—è arc –∏–∑-–∑–∞ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
      signal,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
      openAIProxyUrl,
      // preferOpenAI –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Claude –ø–µ—Ä–≤—ã–º
    });

    console.log(`[HistoryStory] Generated ${mode} using ${result.provider}`);

    const cleanText = result.text
      .replace(/```json\s*/gi, '')
      .replace(/```\s*/g, '')
      .trim();

    let parsed;
    try {
      parsed = JSON.parse(cleanText);
    } catch (parseError) {
      console.error(`[HistoryStory] JSON parse error for ${mode}:`, parseError);
      console.error(`[HistoryStory] Raw text (first 500 chars):`, cleanText.slice(0, 500));

      // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ JSON
      try {
        // –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞: –∑–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
        let fixedText = cleanText
          // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
          .replace(/\\n/g, ' ')
          // –ó–∞–º–µ–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
          .replace(/[\r\n]+/g, ' ')
          // –ó–∞–º–µ–Ω—è–µ–º —Ç–∞–±—É–ª—è—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
          .replace(/\t/g, ' ')
          // –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
          .replace(/\s+/g, ' ')
          // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏ –∏ —Å–∫–æ–±–∫–∞–º–∏
          .replace(/\s+"/g, '"')
          .replace(/\s+}/g, '}')
          .replace(/\s+]/g, ']')
          // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫ –∏ —Å–∫–æ–±–æ–∫
          .replace(/"\s+/g, '"')
          .replace(/{\s+/g, '{')
          .replace(/\[\s+/g, '[');

        parsed = JSON.parse(fixedText);
        console.log(`[HistoryStory] Successfully parsed after fixing newlines and whitespace`);
      } catch (fixError) {
        console.error(`[HistoryStory] Failed to fix and parse, trying to extract valid JSON portion`);

        // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –∏—â–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ —á–∞—Å—Ç–∏ JSON
        try {
          // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É
          const lastBrace = cleanText.lastIndexOf('}');
          if (lastBrace > 0) {
            const truncated = cleanText.substring(0, lastBrace + 1);
            const fixedTruncated = truncated
              .replace(/[\r\n]+/g, ' ')
              .replace(/\s+/g, ' ');
            parsed = JSON.parse(fixedTruncated);
            console.log(`[HistoryStory] Successfully parsed truncated JSON`);
          } else {
            throw parseError;
          }
        } catch (truncError) {
          console.error(`[HistoryStory] All parsing attempts failed, using fallback`);
          throw parseError;
        }
      }
    }

    return normalizeResponse(parsed, {
      mode,
      authorName: author.name,
      genre: author.genre,
      arcLimit,
      currentArc: targetArc,
      contract: resolvedContract,
    });
  } catch (error) {
    if (error instanceof DOMException && error.name === 'AbortError') {
      throw error;
    }
    console.error(`[HistoryStory] Failed to generate ${mode}`, error);

    // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback –Ω–∏ –¥–ª—è finale, –Ω–∏ –¥–ª—è arc
    // Fallback-—Å—Ü–µ–Ω—ã –Ω–∞—Ä—É—à–∞—é—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏–∏
    if (mode === 'finale') {
      throw new Error('–ó–≤—ë–∑–¥—ã –æ—Ç–≤–ª–µ–∫–ª–∏—Å—å –Ω–∞ –∫–æ—Ñ–µ-–±—Ä–µ–π–∫ üåü‚òï –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑?');
    } else {
      throw new Error('–ú—É–∑–∞ —Å–±–µ–∂–∞–ª–∞ –∑–∞ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º ü¶ã –ù–∞–∂–º–∏ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞" ‚Äî –æ–Ω–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è!');
    }
  }
}
