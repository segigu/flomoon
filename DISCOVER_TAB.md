# Discover Tab ("–£–∑–Ω–∞–π —Å–µ–±—è") - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-10-22
**–í–µ—Ä—Å–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞**: v2 (DiscoverTabV2)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–µ "–£–∑–Ω–∞–π —Å–µ–±—è" - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏, –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –∏ voice recording.

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª](#–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª)
  - [Idle Screen](#idle-screen)
  - [Planet Dialogue](#planet-dialogue)
  - [Interactive Story](#interactive-story)
  - [Finale](#finale)
- [Planet Dialogue Mechanism](#planet-dialogue-mechanism)
- [Interactive Story Generation](#interactive-story-generation)
- [Reveal Scroll Mechanism](#reveal-scroll-mechanism)
- [Auto-scroll](#auto-scroll)
- [Voice Recording](#voice-recording)
- [Props & API](#props--api)
- [UI Components](#ui-components)
- [–°—Ç–∏–ª–∏](#—Å—Ç–∏–ª–∏)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞](#–≤–∞–∂–Ω—ã–µ-–ø—Ä–∞–≤–∏–ª–∞)
- [–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π](#–∏—Å—Ç–æ—Ä–∏—è-–∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

## –û–±–∑–æ—Ä

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–í–∫–ª–∞–¥–∫–∞ "–£–∑–Ω–∞–π —Å–µ–±—è" - —ç—Ç–æ **–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞** —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é
2. –í–∏–¥–∏—Ç –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ –ø–ª–∞–Ω–µ—Ç (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É)
3. –ü—Ä–æ—Ö–æ–¥–∏—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Å –≤—ã–±–æ—Ä–∞–º–∏ (7 —Å–µ–≥–º–µ–Ω—Ç–æ–≤)
4. –ü–æ–ª—É—á–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –≤—ã–±–æ—Ä–æ–≤ (–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é + –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é)

### –í–µ—Ä—Å–∏—è v2 vs v1

**DiscoverTabV2** - –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º:

| –ê—Å–ø–µ–∫—Ç | v1 (—Å—Ç–∞—Ä–∞—è) | v2 (–Ω–æ–≤–∞—è) |
|--------|-------------|------------|
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–º** | –†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–π state | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π ChatManager |
| **–ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª** | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ useEffect | –ï–¥–∏–Ω—ã–π useChatScroll hook |
| **Voice recording** | State –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ | Props-based —á–µ—Ä–µ–∑ ChatManager |
| **–ö–æ–¥** | ~2000 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ | 1353 —Å—Ç—Ä–æ–∫–∏, —á–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ |

**URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:
- v2 (–Ω–æ–≤–∞—è): `http://localhost:3000/nastia-calendar?newDiscover=true`
- v1 (—Å—Ç–∞—Ä–∞—è): `http://localhost:3000/nastia-calendar`

### –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [VOICE_RECORDING.md](VOICE_RECORDING.md) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∫–Ω–æ–ø–∫–µ "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"
- [AUTOSCROLL_FIX.md](AUTOSCROLL_FIX.md) - –î–µ—Ç–∞–ª–∏ –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞
- [TECHNICAL_DOCS.md](TECHNICAL_DOCS.md) - –û–±—â–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [CLAUDE.md](CLAUDE.md) - –û–±–∑–æ—Ä –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
App.tsx
  ‚Üì
ModernNastiaApp.tsx (tab switcher)
  ‚Üì
DiscoverTabV2.tsx (state owner)
  ‚Üì
ChatManager.tsx (chat controller)
  ‚Üì
ChatChoices.tsx (buttons UI)
```

### State Management

**–í DiscoverTabV2 (state owner)**:

```typescript
// –û—Å–Ω–æ–≤–Ω–æ–π state
const [isStarted, setIsStarted] = useState(false);           // –ù–∞—á–∞–ª–∏ –ª–∏ –∏—Å—Ç–æ—Ä–∏—é
const [isGenerating, setIsGenerating] = useState(false);     // AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
const [error, setError] = useState<string | null>(null);     // –û—à–∏–±–∫–∏
const [storyMeta, setStoryMeta] = useState<HistoryStoryMeta | null>(null); // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏
const [currentArc, setCurrentArc] = useState(1);             // –¢–µ–∫—É—â–∏–π —Å–µ–≥–º–µ–Ω—Ç (1-7)
const [storyContract, setStoryContract] = useState<string | null>(null); // –ü—Å–∏—Ö–æ-–∫–æ–Ω—Ç—Ä–∞–∫—Ç

// Finale state
const [finaleInterpretations, setFinaleInterpretations] = useState<{
  human: string;
  astrological: string;
} | null>(null);
const [finaleInterpretationMode, setFinaleInterpretationMode] = useState<'human' | 'astrological'>('human');

// Voice recording state (—Å–º. VOICE_RECORDING.md)
const [customOption, setCustomOption] = useState<{
  status: CustomOptionStatus;
  option: HistoryStoryOption | null;
  transcript?: string;
  error?: string;
}>({ status: 'idle', option: null });
const [customRecordingLevel, setCustomRecordingLevel] = useState(0);

// Idle screen
const [startPrompt] = useState(() => random(HISTORY_START_PROMPTS));
const [startButton] = useState(() => random(HISTORY_START_BUTTONS));
const [startDescription] = useState(() => random(HISTORY_START_DESCRIPTIONS));
const [visibleElements, setVisibleElements] = useState<string[]>([]);
```

### Refs –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

```typescript
// ChatManager ref
const chatManagerRef = useRef<ChatManagerHandle>(null);

// –¢–∞–π–º–µ—Ä—ã
const timeoutsRef = useRef<NodeJS.Timeout[]>([]);

// Props refs (–¥–ª—è callbacks)
const personalizedMessagesRef = useRef(personalizedPlanetMessages);
const isLoadingRef = useRef(isLoadingPersonalizedMessages);

// AI generation refs
const aiResultRef = useRef<any>(null);                    // –†–µ–∑—É–ª—å—Ç–∞—Ç AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
const stopDialogueAfterCurrentRef = useRef<boolean>(false); // –§–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∏–∞–ª–æ–≥–∞
const dialogueStartedRef = useRef<boolean>(false);        // –î–∏–∞–ª–æ–≥ –∑–∞–ø—É—â–µ–Ω

// Story refs
const storySegmentsRef = useRef<StorySegment[]>([]);      // –ò—Å—Ç–æ—Ä–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
const currentChoicesRef = useRef<HistoryStoryOption[]>([]); // –¢–µ–∫—É—â–∏–µ choices

// Voice recording refs (—Å–º. VOICE_RECORDING.md)
const mediaRecorderRef = useRef<MediaRecorder | null>(null);
const mediaStreamRef = useRef<MediaStream | null>(null);
const audioChunksRef = useRef<Blob[]>([]);
const audioContextRef = useRef<AudioContext | null>(null);
const audioAnalyserRef = useRef<AnalyserNode | null>(null);
const analyserDataRef = useRef<Uint8Array | null>(null);
const recordingAnimationFrameRef = useRef<number | null>(null);
const customOptionAbortControllerRef = useRef<AbortController | null>(null);
```

---

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

–í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ 4 –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–∑—ã:

```
Idle Screen
    ‚Üì [–∫–ª–∏–∫ "–ù–∞—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é"]
Planet Dialogue (–¥–∏–∞–ª–æ–≥ –ø–ª–∞–Ω–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è AI)
    ‚Üì [AI —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –ø–µ—Ä–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç]
Interactive Story (arcs 1-7, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –≤—ã–±–æ—Ä—ã)
    ‚Üì [arc 7 ‚Üí finale mode]
Finale (–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –≤—ã–±–æ—Ä–æ–≤: human + astrological)
    ‚Üì [–∫–ª–∏–∫ "‚úï" ‚Üí reset]
Idle Screen
```

---

### Idle Screen

**–¶–µ–ª—å**: –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ + –∫–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞

**UI —ç–ª–µ–º–µ–Ω—Ç—ã** (–ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 100ms):
1. **–ò–∫–æ–Ω–∫–∞**: ‚ú® (–∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
2. **–ü—Ä–æ–º–ø—Ç**: –†–∞–Ω–¥–æ–º–Ω—ã–π –∏–∑ `HISTORY_START_PROMPTS[]`
3. **–û–ø–∏—Å–∞–Ω–∏–µ**: –†–∞–Ω–¥–æ–º–Ω–æ–µ –∏–∑ `HISTORY_START_DESCRIPTIONS[]`
4. **–ö–Ω–æ–ø–∫–∞**: –†–∞–Ω–¥–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ `HISTORY_START_BUTTONS[]`

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤**:
- "–î–∞–≤–∞–π –ø—Ä–æ–≤–µ—Ä–∏–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—ã –ø—Ä–∞–≤–¥–∏–≤–∞ —Å —Å–æ–±–æ–π —Å–µ–≥–æ–¥–Ω—è"
- "–ì–æ—Ç–æ–≤–∞ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å–µ–±—è –Ω–∞ —á–∞—Å—Ç–∏? –ó–≤—ë–∑–¥—ã —É–∂–µ –Ω–∞—Ç–æ—á–∏–ª–∏ —Å–∫–∞–ª—å–ø–µ–ª—å"
- "–ß—Ç–æ –µ—Å–ª–∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—è –∑–Ω–∞–µ—Ç –æ —Ç–µ–±–µ –±–æ–ª—å—à–µ, —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å?"

**–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è**:
```typescript
// useEffect –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ isStarted=false
useEffect(() => {
  if (isStarted) return;

  setVisibleElements([]);
  const elementsToAnimate = ['icon', 'prompt', 'description', 'button'];
  const timers = elementsToAnimate.map((elementId, index) =>
    window.setTimeout(() => {
      setVisibleElements(prev => [...prev, elementId]);
    }, 100 * index + 50)
  );

  return () => timers.forEach(t => clearTimeout(t));
}, [isStarted]);
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏**:
- **–ê–∫—Ç–∏–≤–Ω–∞**: –µ—Å–ª–∏ `hasAiCredentials` (API –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
- **–ù–µ–∞–∫—Ç–∏–≤–Ω–∞**: —Ç–µ–∫—Å—Ç "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á–∏"

**–ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É** ‚Üí `startPlanetDialogue()`

---

### Planet Dialogue

**–¶–µ–ª—å**: –†–∞–∑–≤–ª–µ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∏–∞–ª–æ–≥–æ–º –ø–ª–∞–Ω–µ—Ç **–ø–æ–∫–∞ AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é** (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥)

**–§–∞–∑—ã Planet Dialogue**:

#### 1. –û—á–∏—Å—Ç–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (0-100ms)
```typescript
setIsGenerating(true);
setIsStarted(true);
chatManagerRef.current?.clearMessages();
chatManagerRef.current?.setPhase('dialogue');
```

#### 2. –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –õ—É–Ω—ã (150ms)
```
üåô –õ—É–Ω–∞: "–¢–∞–∫, –∫–æ–ª–ª–µ–≥–∏, —Å–æ–±–∏—Ä–∞–µ–º—Å—è! –°–µ–π—á–∞—Å –æ–±—Å—É–¥–∏–º, –∫–∞–∫—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ù–∞—Å—Ç–∏ –ø—Ä–∏–¥—É–º–∞—Ç—å..."
```

#### 3. "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" –ø–ª–∞–Ω–µ—Ç (600-4800ms)
–ü–ª–∞–Ω–µ—Ç—ã "–ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è" —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏:

| –ü–ª–∞–Ω–µ—Ç–∞ | –ó–∞–¥–µ—Ä–∂–∫–∞ | –•–∞—Ä–∞–∫—Ç–µ—Ä |
|---------|----------|----------|
| –ú–µ—Ä–∫—É—Ä–∏–π | 600ms | –°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π |
| –ú–∞—Ä—Å | 900ms | –†–µ—à–∏—Ç–µ–ª—å–Ω—ã–π |
| –í–µ–Ω–µ—Ä–∞ | 1300ms | –õ–µ–≥–∫–∞—è, –Ω–µ —Å–ø–µ—à–∏—Ç |
| –£—Ä–∞–Ω | 1500ms | –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π |
| –ü–ª—É—Ç–æ–Ω | 2200ms | –¢—è–∂–µ–ª–æ–≤–µ—Å–Ω—ã–π |
| –Æ–ø–∏—Ç–µ—Ä | 2700ms | –§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π |
| –°–∞—Ç—É—Ä–Ω | 3300ms | –†–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–π |
| –•–∏—Ä–æ–Ω | 4000ms | –ó–∞–¥—É–º—á–∏–≤—ã–π |
| –ù–µ–ø—Ç—É–Ω | 4800ms | –°–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π |

**–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**:
```
‚ö° –ú–µ—Ä–∫—É—Ä–∏–π –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —á–∞—Ç—É...
```

#### 4. –î–∏–∞–ª–æ–≥ –ø–ª–∞–Ω–µ—Ç (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `personalizedPlanetMessages` (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ñ–æ–Ω–æ–º –≤ ModernNastiaApp)

**–õ–æ–≥–∏–∫–∞**:
- –ï—Å–ª–∏ **personalizedPlanetMessages** –¥–æ—Å—Ç—É–ø–Ω—ã ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –ø–æ –æ–¥–Ω–æ–º—É —Å –ø–∞—É–∑–∞–º–∏
- –ï—Å–ª–∏ **–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è** (isLoadingPersonalizedMessages=true) ‚Üí –∂–¥—ë–º
- –ï—Å–ª–∏ **–Ω–µ—Ç** ‚Üí graceful degradation (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ")

**–ü–∞—É–∑—ã –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏**:
```typescript
const pauseBefore = calculatePauseBefore(message);  // –ü–∞—É–∑–∞ –î–û –ø–µ—á–∞—Ç–∞–Ω–∏—è
const typingDuration = calculateTypingDuration(message); // –í—Ä–µ–º—è "–ø–µ—á–∞—Ç–∞–Ω–∏—è"
const pauseAfter = calculatePauseAfter(message);    // –ü–∞—É–∑–∞ –ü–û–°–õ–ï
```

**Polling –¥–ª—è AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**:
```typescript
// –ö–∞–∂–¥—ã–µ 500ms –ø—Ä–æ–≤–µ—Ä—è–µ–º: –≥–æ—Ç–æ–≤ –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç AI?
const pollResult = () => {
  if (aiResultRef.current) {
    stopDialogueAfterCurrentRef.current = true; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  } else {
    setTimeout(pollResult, 500); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
  }
};
```

#### 5. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏

–ö–æ–≥–¥–∞ AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤ –ò —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:
- –°–∫—Ä—ã–≤–∞–µ–º typing indicator
- –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ñ–∞–∑—É: `chatManagerRef.current?.setPhase('story')`
- –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –õ—É–Ω—ã —Å –ø–µ—Ä–≤—ã–º —Å–µ–≥–º–µ–Ω—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ + reveal scroll

---

### Interactive Story

**–¶–µ–ª—å**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é, –¥–µ–ª–∞—è –≤—ã–±–æ—Ä—ã

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **Arc limit**: 7 (7 —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –¥–æ —Ñ–∏–Ω–∞–ª–∞)
- **Current arc**: 1-7 (—Ç–µ–∫—É—â–∏–π —Å–µ–≥–º–µ–Ω—Ç)
- **Story contract**: –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ç–µ–º—ã

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ–≥–º–µ–Ω—Ç–∞**:
```typescript
interface StorySegment {
  text: string;              // –¢–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞ (scene)
  arc: number;               // –ù–æ–º–µ—Ä —Å–µ–≥–º–µ–Ω—Ç–∞ (1-7)
  optionTitle?: string;      // Title –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
  optionDescription?: string; // Description –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
}
```

**–ü–æ—Ç–æ–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è**:

#### 1. –ü–æ–∫–∞–∑ —Å–µ–≥–º–µ–Ω—Ç–∞
```
üåô –õ—É–Ω–∞: [—Ç–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏]

[–ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ 1-4]
[–ö–Ω–æ–ø–∫–∞ "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç" üéôÔ∏è]
```

**Reveal scroll**: –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ ‚Üí –æ—Ç–∫–∞—Ç –∫ –Ω–∞—á–∞–ª—É —Å–æ–æ–±—â–µ–Ω–∏—è –õ—É–Ω—ã

#### 2. –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ö–ª–∏–∫ –Ω–∞ –æ–ø—Ü–∏—é ‚Üí `handleChoiceSelect(choice)`

```typescript
// 1. –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
currentChoicesRef.current = [];
chatManagerRef.current?.setChoices([]);

// 2. –î–æ–±–∞–≤–ª—è–µ–º user message (350ms delay)
chatManagerRef.current?.addMessage({
  type: 'user',
  author: '–ù–∞—Å—Ç—è',
  content: choice.description || choice.title,
});

// 3. Typing indicator (800ms delay)
chatManagerRef.current?.setTyping('–ò—Å—Ç–æ—Ä–∏—è');

// 4. AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
const result = await generateHistoryStoryChunk({
  segments: storySegmentsRef.current.slice(-4), // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  currentChoice: choice,
  mode: isFinaleTime ? 'finale' : 'arc',
  currentArc: nextArc,
  contract: storyContract,
  // ... AI keys
});

// 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
chatManagerRef.current?.addMessage({
  type: 'story',
  author: '–ò—Å—Ç–æ—Ä–∏—è',
  content: result.node.scene,
});

// 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ–≥–º–µ–Ω—Ç
storySegmentsRef.current.push({
  text: result.node.scene,
  arc: nextArc,
  optionTitle: choice.title,
  optionDescription: choice.description,
});

// 7. –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ + reveal scroll
chatManagerRef.current?.setChoices(result.options);
```

#### 3. –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –¥–æ arc 7

**Arc 1-6**: –æ–±—ã—á–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã —Å –≤—ã–±–æ—Ä–∞–º–∏
**Arc 7**: –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ñ–∏–Ω–∞–ª—É

---

### Finale

**–¢—Ä–∏–≥–≥–µ—Ä**: `currentArc > arcLimit` (arc 8)

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è**:
```typescript
const result = await generateHistoryStoryChunk({
  // ...
  mode: 'finale', // ‚Üê –í–∞–∂–Ω–æ!
  currentArc: 8,
});

// result.finale —Å–æ–¥–µ—Ä–∂–∏—Ç:
// - resolution: —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏
// - humanInterpretation: –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –≤—ã–±–æ—Ä–æ–≤
// - astrologicalInterpretation: –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
```

**UI**:
```
üåô –õ—É–Ω–∞: [resolution - —Ñ–∏–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìä –ß—Ç–æ –º—ã –æ —Ç–µ–±–µ —É–∑–Ω–∞–ª–∏                 ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ [–ù–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º] [–ù–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º]  ‚îÇ ‚Üê Toggle buttons
‚îÇ                                          ‚îÇ
‚îÇ [humanInterpretation –ò–õ–ò                ‚îÇ
‚îÇ  astrologicalInterpretation]            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**State**:
```typescript
setFinaleInterpretations({
  human: result.finale.humanInterpretation,
  astrological: result.finale.astrologicalInterpretation,
});
setFinaleInterpretationMode('human'); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤**:
```typescript
const handleFinaleInterpretationToggle = (mode: 'human' | 'astrological') => {
  setFinaleInterpretationMode(mode);
};
```

**Reveal scroll**: –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞ ‚Üí –æ—Ç–∫–∞—Ç –∫ –Ω–∞—á–∞–ª—É finale story message

---

## Planet Dialogue Mechanism

### –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `personalizedPlanetMessages` prop (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ ModernNastiaApp —Ñ–æ–Ω–æ–º)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```typescript
interface PersonalizedPlanetMessages {
  dialogue: Array<{
    planet: string;    // –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–µ—Ä–∫—É—Ä–∏–π")
    message: string;   // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  }>;
  timestamp: number;   // Timestamp –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
}
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è** (–≤ ModernNastiaApp):
- –ü—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ï—Å–ª–∏ –Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ localStorage (24 —á–∞—Å–∞)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI —Å astro context

**–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞**:
```
üåô –õ—É–Ω–∞: "–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –µ—ë –°–æ–ª–Ω—Ü–µ –≤ –†–∞–∫–µ ‚Äî –¥–æ–º–∞—à–Ω—è—è, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è..."

‚òø –ú–µ—Ä–∫—É—Ä–∏–π: "–ê –ú–µ—Ä–∫—É—Ä–∏–π —É –Ω–µ—ë –≤ –ë–ª–∏–∑–Ω–µ—Ü–∞—Ö ‚Äî –±—ã—Å—Ç—Ä–∞—è, –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–∞—è. –ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è!"

‚ôÄ –í–µ–Ω–µ—Ä–∞: "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ –í–µ–Ω–µ—Ä—É –≤ –õ—å–≤–µ ‚Äî –æ–Ω–∞ –ª—é–±–∏—Ç, –∫–æ–≥–¥–∞ –µ—ë —Ü–µ–Ω—è—Ç!"

...
```

### –ê–Ω–∏–º–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞

**Timing –ø–ª–∞–Ω–µ—Ç** (lines 234-257):
```typescript
const planetsWithDelays = [
  { planet: '–ú–µ—Ä–∫—É—Ä–∏–π', delay: 600 },
  { planet: '–ú–∞—Ä—Å', delay: 900 },
  { planet: '–í–µ–Ω–µ—Ä–∞', delay: 1300 },
  // ... –≤—Å–µ–≥–æ 9 –ø–ª–∞–Ω–µ—Ç
];

planetsWithDelays.forEach(({ planet, delay }) => {
  setTimeout(() => {
    chatManagerRef.current?.addMessage({
      type: 'system',
      author: planet,
      content: '–ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —á–∞—Ç—É...',
    });
  }, delay);
});
```

### –ü–æ–∫–∞–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–õ–æ–≥–∏–∫–∞** (lines 262-394):
```typescript
const runDialogue = (messages: Array<{ planet: string; message: string }>) => {
  let cumulativeDelay = 5500; // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø–ª–∞–Ω–µ—Ç

  messages.forEach((msg, index) => {
    const pauseBefore = calculatePauseBefore(msg.message);
    const typingDuration = calculateTypingDuration(msg.message);
    const pauseAfter = calculatePauseAfter(msg.message);

    cumulativeDelay += pauseBefore;

    setTimeout(() => {
      // Typing indicator
      chatManagerRef.current?.setTyping(msg.planet);
    }, cumulativeDelay);

    cumulativeDelay += typingDuration;

    setTimeout(() => {
      // –°–æ–æ–±—â–µ–Ω–∏–µ
      chatManagerRef.current?.addMessage({
        type: 'planet',
        author: msg.planet,
        content: msg.message,
      });
      chatManagerRef.current?.setTyping(null);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥?
      if (stopDialogueAfterCurrentRef.current) {
        showAIResult(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
      } else if (index < messages.length - 1) {
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∏–∞–ª–æ–≥
      } else {
        // –î–∏–∞–ª–æ–≥ –∑–∞–∫–æ–Ω—á–µ–Ω, –Ω–æ AI –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ ‚Üí polling
        pollForResult();
      }
    }, cumulativeDelay);

    cumulativeDelay += pauseAfter;
  });
};
```

### Polling –¥–ª—è AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–ó–∞—á–µ–º**: –î–∏–∞–ª–æ–≥ –º–æ–∂–µ—Ç –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è —Ä–∞–Ω—å—à–µ —á–µ–º AI —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é

```typescript
const pollForResult = () => {
  if (aiResultRef.current) {
    showAIResult();
  } else {
    setTimeout(pollForResult, 500); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 500ms
  }
};
```

### Graceful degradation

**–ï—Å–ª–∏ personalizedPlanetMessages –Ω–µ—Ç**:
- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" –ø–ª–∞–Ω–µ—Ç
- –°—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ–º polling –¥–ª—è AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –ø–ª–∞–Ω–µ—Ç ‚Üí –∏—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞

---

## Interactive Story Generation

### AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤

**–§—É–Ω–∫—Ü–∏—è**: `generateHistoryStoryChunk()` –∏–∑ [src/utils/historyStory.ts](src/utils/historyStory.ts)

**–í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
```typescript
{
  segments: StorySegment[],           // –ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã (–∫–æ–Ω—Ç–µ–∫—Å—Ç)
  currentChoice?: HistoryStoryOption, // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  summary?: string,                   // Summary –∏—Å—Ç–æ—Ä–∏–∏
  author: {                           // –ê–≤—Ç–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏
    name: string,
    stylePrompt: string,
    genre: string,
  },
  arcLimit: number,                   // –õ–∏–º–∏—Ç —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (7)
  mode: 'arc' | 'finale',             // –†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  currentArc: number,                 // –¢–µ–∫—É—â–∏–π arc (1-7)
  contract?: string,                  // –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  openAIProxyUrl?: string,
}
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (mode='arc'):
```typescript
{
  node: {
    scene: string,              // –¢–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏
  },
  options: HistoryStoryOption[], // –í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ (–æ–±—ã—á–Ω–æ 3-4)
  contract?: string,            // –ü—Å–∏—Ö–æ-–∫–æ–Ω—Ç—Ä–∞–∫—Ç (–µ—Å–ª–∏ –Ω–æ–≤—ã–π)
}
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (mode='finale'):
```typescript
{
  finale: {
    resolution: string,                 // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏
    humanInterpretation: string,        // –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
    astrologicalInterpretation: string, // –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
  }
}
```

### –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

**–¶–µ–ª—å**: –ò–∑–±–µ–≥–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Ç–µ–º –≤ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏—è—Ö

**–•—Ä–∞–Ω–µ–Ω–∏–µ**: `NastiaData.psychContractHistory` (localStorage)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```typescript
interface PsychContractHistory {
  contracts: string[];          // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã (–º–∞–∫—Å 10)
  scenarios: string[];          // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–º–∞–∫—Å 30)
  contractScenarios: Record<string, string[]>; // –°—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º (–º–∞–∫—Å 5/–∫–æ–Ω—Ç—Ä–∞–∫—Ç)
}
```

**–õ–æ–≥–∏–∫–∞**:
1. –ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ AI –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç
2. –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `storyContract`
3. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ—Ç –∂–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç
4. –ü–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é

**–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤**:
- "–ü–æ–∏—Å–∫ —Å–µ–±—è —á–µ—Ä–µ–∑ –æ—Ç–Ω–æ—à–µ–Ω–∏—è"
- "–ö–∞—Ä—å–µ—Ä–∞ vs –ª–∏—á–Ω–∞—è –∂–∏–∑–Ω—å"
- "–ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ö–æ–≤"

**–°–º.**: [src/data/psychologicalContracts.ts](src/data/psychologicalContracts.ts)

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI

**–°–µ–≥–º–µ–Ω—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏**:
```typescript
const recentSegments = storySegmentsRef.current.slice(-4); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 4
```

**–ü–æ—á–µ–º—É –Ω–µ –≤—Å–µ?**
- –ü—Ä–æ–º–ø—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º
- 4 —Å–µ–≥–º–µ–Ω—Ç–∞ (~1000-2000 —Ç–æ–∫–µ–Ω–æ–≤) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ë–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –≤–ª–∏—è—é—Ç —Å–ª–∞–±–æ

**–ú–æ–¥–µ–ª—å**: `claude-haiku-4.5` (primary), OpenAI (fallback)

---

## Reveal Scroll Mechanism

**–¶–µ–ª—å**: –ö—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Å –ø–æ–∫–∞–∑–æ–º –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –æ—Ç–∫–∞—Ç–æ–º

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω?

–ü—Ä–æ–±–ª–µ–º–∞: –ö–Ω–æ–ø–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (500ms/–∫–Ω–æ–ø–∫–∞). –ï—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞.

**–†–µ—à–µ–Ω–∏–µ**:
1. **–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë**: –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –ø–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –í–°–ï–• –∫–Ω–æ–ø–æ–∫
2. **–û—Ç–∫–∞—Ç–∏—Ç—å**: –ß–µ—Ä–µ–∑ 800ms –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É —Å–æ–æ–±—â–µ–Ω–∏—è (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—á–∏—Ç–∞–ª)
3. **–ü—Ä–æ—Ñ–∏—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—Ç–æ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ ‚Üí —Å–∫—Ä–æ–ª–ª–∏—Ç –≤–Ω–∏–∑ —Å–∞–º –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤

### –ê–ª–≥–æ—Ä–∏—Ç–º

**–î–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞** (arc 1, lines 457-504):
```typescript
const expectedButtonCount = options.length + 1; // +1 –¥–ª—è "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"
const animationDuration = expectedButtonCount * 500; // 500ms/–∫–Ω–æ–ø–∫–∞

setTimeout(() => {
  // –®–∞–≥ 1: –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ (–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë)
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        window.scrollTo({
          top: document.documentElement.scrollHeight,
          behavior: 'smooth',
        });

        // –®–∞–≥ 2: –û—Ç–∫–∞—Ç –∫ –Ω–∞—á–∞–ª—É moon message (—á–µ—Ä–µ–∑ 800ms)
        setTimeout(() => {
          const moonMessage = document.querySelector('[data-message-type="moon"]');
          if (moonMessage) {
            const rect = moonMessage.getBoundingClientRect();
            const currentScroll = window.pageYOffset;
            const moonTop = rect.top + currentScroll;
            const headerHeight = 60;
            const targetScroll = moonTop - headerHeight;

            window.scrollTo({
              top: targetScroll,
              behavior: 'smooth',
            });
          }
        }, 800);
      });
    });
  });
}, animationDuration + 200); // –ñ–¥—ë–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫
```

**–î–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ 2-7** (lines 718-762):
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É `[data-message-type="story"]`

**–î–ª—è finale** (lines 643-680):
- –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É finale story message

### –ü–æ—á–µ–º—É triple RAF?

```typescript
requestAnimationFrame(() => {       // 1. –°–ª–µ–¥—É—é—â–∏–π frame
  requestAnimationFrame(() => {     // 2. –ï—â—ë –æ–¥–∏–Ω frame
    requestAnimationFrame(() => {   // 3. –ì–∞—Ä–∞–Ω—Ç–∏—è —Ä–µ–Ω–¥–µ—Ä–∞
      window.scrollTo(...);
    });
  });
});
```

**–ü—Ä–∏—á–∏–Ω–∞**: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ DOM —ç–ª–µ–º–µ–Ω—Ç—ã (–∫–Ω–æ–ø–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è) –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã –ø–µ—Ä–µ–¥ —Å–∫—Ä–æ–ª–ª–æ–º.

**–°–º.**: [AUTOSCROLL_FIX.md](AUTOSCROLL_FIX.md) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

### ‚ö†Ô∏è –í–ê–ñ–ù–û: window.scrollTo, –ù–ï container

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
window.scrollTo({ top: ..., behavior: 'smooth' });

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
container.scrollTo({ top: ..., behavior: 'smooth' });
```

**–ü—Ä–∏—á–∏–Ω–∞**: `.historyChatContainer` –ù–ï –∏–º–µ–µ—Ç `overflow: scroll`, —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è –≤–µ—Å—å `window`.

---

## Auto-scroll

**–¶–µ–ª—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–æ–ª–ª–∏—Ç—å –≤–Ω–∏–∑ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–¢—Ä–∏–≥–≥–µ—Ä**: `handleMessagesChange()` callback –æ—Ç ChatManager

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è** (lines 167-181):
```typescript
const handleMessagesChange = useCallback(() => {
  // Triple RAF –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∞
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        window.scrollTo({
          top: document.documentElement.scrollHeight,
          behavior: 'smooth',
        });
      });
    });
  });
}, []);
```

**–ü–µ—Ä–µ–¥–∞—á–∞ –≤ ChatManager**:
```typescript
<ChatManager
  onMessagesChange={handleMessagesChange}
  // ...
/>
```

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**:
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (`addMessage`)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (`addMessages`)

**Padding-bottom —É—á—ë—Ç**:
- `.historyChatContainer` –∏–º–µ–µ—Ç `padding-bottom: 16px`
- –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –æ—Ç—Å—Ç—É–ø –æ—Ç glass tab bar –≤–Ω–∏–∑—É
- `scrollHeight` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç padding

**–°–º.**: [AUTOSCROLL_FIX.md](AUTOSCROLL_FIX.md) –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

---

## Voice Recording

**–ö–Ω–æ–ø–∫–∞ "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"** - –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–º —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.

### –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä

1. **–ó–∞–ø–∏—Å—å**: MediaRecorder API —Å audio level visualization
2. **–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è**: OpenAI Whisper API
3. **AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è**: Claude/OpenAI —Å–æ–∑–¥–∞—é—Ç title + description
4. **–í—ã–±–æ—Ä**: –ì–æ—Ç–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ DiscoverTabV2

**Props flow** (props-based architecture):
```typescript
<ChatManager
  customOption={customOption.option || undefined}
  customStatus={customOption.status}
  recordingLevel={customRecordingLevel}
  onCustomOptionClick={handleCustomOptionClick}
  // ...
/>
```

**‚ö†Ô∏è –í–ê–ñ–ù–û**: State —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ DiscoverTabV2, –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ props ‚Üí ChatManager ‚Üí ChatChoices

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `setChoices()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è custom button state - —ç—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª!

### –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–°–º.**: [VOICE_RECORDING.md](VOICE_RECORDING.md) –¥–ª—è:
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –í—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π (idle/recording/transcribing/generating/ready/error)
- API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (MediaRecorder, Whisper, AI)
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ audio level
- Troubleshooting –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

---

## Props & API

### Props (DiscoverTabV2)

```typescript
interface DiscoverTabV2Props {
  // AI credentials
  hasAiCredentials: boolean;                              // –ï—Å—Ç—å –ª–∏ API –∫–ª—é—á–∏
  effectiveClaudeKey: string | null | undefined;         // Claude API key
  effectiveClaudeProxyUrl: string | null | undefined;    // Claude proxy URL
  effectiveOpenAIKey: string | null | undefined;         // OpenAI API key
  effectiveOpenAIProxyUrl: string | null | undefined;    // OpenAI proxy URL

  // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç
  personalizedPlanetMessages: PersonalizedPlanetMessages | null;
  isLoadingPersonalizedMessages: boolean;

  // Callbacks
  onNewStoryMessage?: () => void;                        // Badge update –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
}
```

### ChatManager ref methods

```typescript
chatManagerRef.current?.addMessage(message);              // –î–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
chatManagerRef.current?.addMessages(messages);            // –î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ
chatManagerRef.current?.setTyping(author | null);         // Typing indicator
chatManagerRef.current?.setPhase(phase);                  // –°–º–µ–Ω–∏—Ç—å —Ñ–∞–∑—É
chatManagerRef.current?.clearMessages();                  // –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
chatManagerRef.current?.setChoices(choices);              // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
chatManagerRef.current?.hideChoices();                    // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏
chatManagerRef.current?.getPhase();                       // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É
chatManagerRef.current?.getMessages();                    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
chatManagerRef.current?.getCurrentArc();                  // –ü–æ–ª—É—á–∏—Ç—å arc –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ story msg
```

**–°–º.**: [src/components/chat/ChatManager.tsx](src/components/chat/ChatManager.tsx) –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ API

---

## UI Components

### Idle Screen

**–§–∞–π–ª**: [src/components/DiscoverTabV2.tsx](src/components/DiscoverTabV2.tsx) (lines 1248-1271)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```jsx
<div className={styles.historyStartScreen}>
  {/* –ò–∫–æ–Ω–∫–∞ */}
  <div className={`${styles.historyStartIconContainer} ${styles.calendarElementAnimated} ${visible ? styles.calendarElementVisible : ''}`}>
    <div className={styles.historyStartIcon}>‚ú®</div>
  </div>

  {/* –ü—Ä–æ–º–ø—Ç */}
  <div className={`${styles.historyStartPrompt} ${styles.calendarElementAnimated} ${visible ? styles.calendarElementVisible : ''}`}>
    {startPrompt}
  </div>

  {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
  <div className={`${styles.historyStartDescription} ${styles.calendarElementAnimated} ${visible ? styles.calendarElementVisible : ''}`}>
    {startDescription}
  </div>

  {/* –ö–Ω–æ–ø–∫–∞ */}
  <button className={`${styles.historyStartButton} ${styles.calendarElementAnimated} ${visible ? styles.calendarElementVisible : ''}`}>
    {hasAiCredentials ? startButton : '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á–∏'}
  </button>
</div>
```

**–ê–Ω–∏–º–∞—Ü–∏—è**: `.calendarElementAnimated` ‚Üí `.calendarElementVisible` (opacity 0‚Üí1, transform)

---

### Story Header

**–§–∞–π–ª**: [src/components/DiscoverTabV2.tsx](src/components/DiscoverTabV2.tsx) (lines 1277-1292)

```jsx
<div className={styles.historyStoryHeader}>
  <h2 className={styles.historyStoryTitle}>
    –ò—Å—Ç–æ—Ä–∏—è <span style={{ fontSize: '14px', opacity: 0.6 }}>(NEW v2 üß™)</span>
  </h2>
  <button
    type="button"
    className={styles.historyCloseButton}
    onClick={resetDiscover}
    aria-label="–ó–∞–∫—Ä—ã—Ç—å"
  >
    ‚úï
  </button>
</div>
```

**–ü—Ä–∏ –∫–ª–∏–∫–µ "‚úï"** ‚Üí `resetDiscover()`:
- –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤
- –û—á–∏—Å—Ç–∫–∞ voice recording —Ä–µ—Å—É—Ä—Å–æ–≤
- Reset –≤—Å–µ—Ö state –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- –í–æ–∑–≤—Ä–∞—Ç –∫ idle screen

---

### Finale Interpretations

**–§–∞–π–ª**: [src/components/DiscoverTabV2.tsx](src/components/DiscoverTabV2.tsx) (lines 1307-1333)

```jsx
{finaleInterpretations && !isGenerating && (
  <div className={`${styles.historyChatBubble} ${styles.historyFinalSummaryBubble}`}>
    <div className={styles.historyFinalSummaryHeader}>
      <div className={styles.historyFinalSummaryLabel}>–ß—Ç–æ –º—ã –æ —Ç–µ–±–µ —É–∑–Ω–∞–ª–∏</div>

      {/* Toggle buttons */}
      <div className={styles.insightStyleToggle}>
        <button
          className={`${styles.insightStyleButton} ${finaleInterpretationMode === 'human' ? styles.active : ''}`}
          onClick={() => handleFinaleInterpretationToggle('human')}
        >
          –ù–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º
        </button>
        <button
          className={`${styles.insightStyleButton} ${finaleInterpretationMode === 'astrological' ? styles.active : ''}`}
          onClick={() => handleFinaleInterpretationToggle('astrological')}
        >
          –ù–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º
        </button>
      </div>
    </div>

    {/* Interpretation text */}
    <div className={styles.historyFinalSummaryText}>
      {finaleInterpretationMode === 'human'
        ? finaleInterpretations.human
        : finaleInterpretations.astrological}
    </div>
  </div>
)}
```

---

### Error Display

**–§–∞–π–ª**: [src/components/DiscoverTabV2.tsx](src/components/DiscoverTabV2.tsx) (lines 1336-1348)

```jsx
{error && (
  <div className={styles.historyStoryError}>
    <span>{error}</span>
    <button
      type="button"
      className={styles.historyStoryRetry}
      onClick={startPlanetDialogue}
      disabled={isGenerating}
    >
      –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
    </button>
  </div>
)}
```

**–ö–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è**:
- AI generation failed
- –ù–µ—Ç API –∫–ª—é—á–µ–π
- Network errors

---

## –°—Ç–∏–ª–∏

**–§–∞–π–ª**: [src/components/NastiaApp.module.css](src/components/NastiaApp.module.css)

### –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

```css
.historyChatContainer {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding: 0.5rem;
  padding-bottom: 16px;        /* ‚Üê –û—Ç—Å—Ç—É–ø –æ—Ç tab bar */
  margin-bottom: 1rem;
  background: transparent;
  min-height: 70vh;
}
```

**‚ö†Ô∏è –í–ê–ñ–ù–û**: `padding-bottom: 16px` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ glass tab bar

### Idle Screen

```css
.historyStartScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
  padding: 2rem 1rem;
  min-height: 70vh;
}

.historyStartIconContainer {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #FFB6C1, #DDA0DD);
}

.historyStartIcon {
  font-size: 48px;
  animation: pulse 2s ease-in-out infinite;
}

.historyStartPrompt {
  font-size: 20px;
  font-weight: 600;
  text-align: center;
  color: var(--nastia-dark);
}

.historyStartDescription {
  font-size: 14px;
  text-align: center;
  color: rgba(0, 0, 0, 0.6);
  max-width: 400px;
}

.historyStartButton {
  padding: 12px 32px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 25px;
  background: linear-gradient(135deg, #FFB6C1, #DDA0DD);
  color: white;
  cursor: pointer;
  transition: transform 0.2s;
}
```

### –ê–Ω–∏–º–∞—Ü–∏–∏

```css
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.calendarElementAnimated {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.5s, transform 0.5s;
}

.calendarElementVisible {
  opacity: 1;
  transform: translateY(0);
}
```

### Story Header

```css
.historyStoryHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
}

.historyCloseButton {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transition: background 0.2s;
}
```

### Finale Interpretations

```css
.historyFinalSummaryBubble {
  background: linear-gradient(135deg, #FFF0F5, #F8F8FF);
  border: 2px solid #FFB6C1;
  border-radius: 16px;
  padding: 1.5rem;
  margin-top: 1rem;
}

.historyFinalSummaryHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.insightStyleToggle {
  display: flex;
  gap: 0.5rem;
  background: rgba(255, 255, 255, 0.5);
  padding: 4px;
  border-radius: 20px;
}

.insightStyleButton {
  padding: 6px 12px;
  font-size: 12px;
  border: none;
  border-radius: 16px;
  background: transparent;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.insightStyleButton.active {
  background: white;
  color: var(--nastia-dark);
}
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (v2)**:
```
http://localhost:3000/nastia-calendar?newDiscover=true
```

**–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (v1)** - –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
```
http://localhost:3000/nastia-calendar
```

### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### 1. –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (Idle ‚Üí Story ‚Üí Finale)

**–®–∞–≥–∏**:
1. –û—Ç–∫—Ä—ã—Ç—å `?newDiscover=true`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å idle screen:
   - ‚úÖ –ò–∫–æ–Ω–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π
   - ‚úÖ –ü—Ä–æ–º–ø—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤—Ç–æ—Ä—ã–º
   - ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º
   - ‚úÖ –ö–Ω–æ–ø–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–µ–π
3. –ö–ª–∏–∫–Ω—É—Ç—å "–ù–∞—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å planet dialogue:
   - ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –õ—É–Ω—ã –ø–æ—è–≤–ª—è–µ—Ç—Å—è
   - ‚úÖ –ü–ª–∞–Ω–µ—Ç—ã "–ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è" —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
   - ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω astro)
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏:
   - ‚úÖ –§–∞–∑–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 'story'
   - ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –õ—É–Ω—ã —Å –ø–µ—Ä–≤—ã–º —Å–µ–≥–º–µ–Ω—Ç–æ–º
   - ‚úÖ –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
   - ‚úÖ Reveal scroll: –≤–Ω–∏–∑ ‚Üí –æ—Ç–∫–∞—Ç –∫ –Ω–∞—á–∞–ª—É
6. –°–¥–µ–ª–∞—Ç—å 7 –≤—ã–±–æ—Ä–æ–≤:
   - ‚úÖ User message –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
   - ‚úÖ Typing indicator "–ò—Å—Ç–æ—Ä–∏—è"
   - ‚úÖ –ù–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è
   - ‚úÖ –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ + reveal scroll
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å finale (–ø–æ—Å–ª–µ 7-–≥–æ –≤—ã–±–æ—Ä–∞):
   - ‚úÖ –§–∞–∑–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 'finale'
   - ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
   - ‚úÖ –ë–ª–æ–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –ø–æ—è–≤–ª—è–µ—Ç—Å—è
   - ‚úÖ Toggle "–ù–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º" / "–ù–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º" —Ä–∞–±–æ—Ç–∞–µ—Ç
8. –ö–ª–∏–∫–Ω—É—Ç—å "‚úï":
   - ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∫ idle screen
   - ‚úÖ –í—Å–µ state —Å–±—Ä–æ—à–µ–Ω—ã

#### 2. Voice Recording

**–°–º.**: [VOICE_RECORDING.md#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](VOICE_RECORDING.md#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–ö—Ä–∞—Ç–∫–∏–µ —à–∞–≥–∏**:
1. –î–æ–π—Ç–∏ –¥–æ –ª—é–±–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏
2. –ö–ª–∏–∫–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç" (üéôÔ∏è)
3. –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å transcription ‚Üí AI generation ‚Üí ready state
5. –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –≥–æ—Ç–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

#### 3. Reveal Scroll

**–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ reveal scroll —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–®–∞–≥–∏**:
1. –î–æ–π—Ç–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ (arc 1)
2. –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ—è–≤–ª–µ–Ω–∏—è –í–°–ï–• –∫–Ω–æ–ø–æ–∫
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ (–≤–∏–¥–Ω–æ –≤—Å–µ –∫–Ω–æ–ø–∫–∏)
   - ‚úÖ –ß–µ—Ä–µ–∑ ~800ms –æ—Ç–∫–∞—Ç –∫ –Ω–∞—á–∞–ª—É moon message
   - ‚úÖ Moon message –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–¥ —à–∞–ø–∫–æ–π (60px –æ—Ç—Å—Ç—É–ø)
4. –°–¥–µ–ª–∞—Ç—å –≤—ã–±–æ—Ä, –ø–µ—Ä–µ–π—Ç–∏ –∫ arc 2
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
   - ‚úÖ –û—Ç–∫–∞—Ç –∫ –Ω–∞—á–∞–ª—É story message (–ù–ï moon!)

#### 4. Error Handling

**AI generation failed**:
1. –û—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
2. –ö–ª–∏–∫–Ω—É—Ç—å "–ù–∞—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
   - ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"
   - ‚úÖ –ü—Ä–∏ –∫–ª–∏–∫–µ - –Ω–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞

**No API keys**:
1. –£–¥–∞–ª–∏—Ç—å API –∫–ª—é—á–∏ –∏–∑ localStorage
2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á–∏" (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)

#### 5. Personalized Messages

**–° –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π**:
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É
2. –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ personalized messages
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –î–∏–∞–ª–æ–≥ –ø–ª–∞–Ω–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞—Å—Ç—Ä–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç—É

**–ë–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏**:
1. –û—á–∏—Å—Ç–∏—Ç—å nativity data
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –¢–æ–ª—å–∫–æ "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" –ø–ª–∞–Ω–µ—Ç
   - ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–æ–≥–¥–∞ AI –≥–æ—Ç–æ–≤

---

## –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### ‚ö†Ô∏è –ù–ï –º–µ–Ω—è—Ç—å reveal scroll –ª–æ–≥–∏–∫—É

**Reveal scroll** —Ç—â–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø–ª–∞–≤–Ω–æ–π UX. –ò–∑–º–µ–Ω–µ–Ω–∏–µ timing'–æ–≤ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
```typescript
const animationDuration = expectedButtonCount * 500; // 500ms/–∫–Ω–æ–ø–∫–∞
setTimeout(() => { /* reveal scroll */ }, 800);      // 800ms –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
const headerHeight = 60;                              // –í—ã—Å–æ—Ç–∞ —à–∞–ø–∫–∏
```

**–°–º.**: [Reveal Scroll Mechanism](#reveal-scroll-mechanism)

### ‚ö†Ô∏è window.scrollTo, –ù–ï container

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
window.scrollTo({ top: ..., behavior: 'smooth' });

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
const container = document.querySelector('.historyChatContainer');
container.scrollTo({ ... }); // –ù–ï –†–ê–ë–û–¢–ê–ï–¢! Container –Ω–µ –∏–º–µ–µ—Ç overflow: scroll
```

**–°–º.**: [AUTOSCROLL_FIX.md](AUTOSCROLL_FIX.md)

### ‚ö†Ô∏è Voice recording —á–µ—Ä–µ–∑ props

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `setChoices()` –≤ useEffect –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è custom button state!

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–∑–¥–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
useEffect(() => {
  chatManagerRef.current?.setChoices(
    choices, customOption.option, customOption.status, customRecordingLevel
  );
}, [customOption.status]);

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —á–µ—Ä–µ–∑ props
<ChatManager
  customOption={customOption.option}
  customStatus={customOption.status}
  recordingLevel={customRecordingLevel}
/>
```

**–°–º.**: [VOICE_RECORDING.md#–≤–∞–∂–Ω—ã–µ-–ø—Ä–∞–≤–∏–ª–∞](VOICE_RECORDING.md#–≤–∞–∂–Ω—ã–µ-–ø—Ä–∞–≤–∏–ª–∞)

### ‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏

**–í–°–ï–ì–î–ê** —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞:
```
http://localhost:3000/nastia-calendar?newDiscover=true
```

**–ù–ï** –Ω–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ (`/nastia-calendar`)!

### ‚ö†Ô∏è Triple RAF –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ** triple `requestAnimationFrame` –ø–µ—Ä–µ–¥ `window.scrollTo()`:

```typescript
requestAnimationFrame(() => {
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      window.scrollTo(...);
    });
  });
});
```

**–ü—Ä–∏—á–∏–Ω–∞**: –ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ DOM –ø–µ—Ä–µ–¥ —Å–∫—Ä–æ–ª–ª–æ–º

### ‚ö†Ô∏è Cleanup —Ä–µ—Å—É—Ä—Å–æ–≤

–ü—Ä–∏ unmount –∏–ª–∏ reset **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –æ—á–∏—â–∞–π—Ç–µ:
- –¢–∞–π–º–µ—Ä—ã (`timeoutsRef.current`)
- MediaRecorder –∏ MediaStream
- AudioContext
- AbortController
- Animation frames

**–°–º.**: `resetDiscover()` –∏ `cleanupCustomOptionResources()`

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2025-10-22: Props-based Voice Recording Architecture
**–ü—Ä–æ–±–ª–µ–º–∞**: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–Ω–æ–ø–∫–∏ "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"

**–†–µ—à–µ–Ω–∏–µ**:
- –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É `customOption/customStatus/recordingLevel` —á–µ—Ä–µ–∑ props
- –£–¥–∞–ª–µ–Ω–∏–µ state –∏–∑ ChatManager –¥–ª—è —ç—Ç–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –£–¥–∞–ª–µ–Ω–∏–µ useEffect sync —Ü–∏–∫–ª–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- `ChatManager.tsx`: –¥–æ–±–∞–≤–ª–µ–Ω—ã props –¥–ª—è voice state
- `DiscoverTabV2.tsx`: –ø–µ—Ä–µ–¥–∞—á–∞ props –≤–º–µ—Å—Ç–æ setChoices() –≤ useEffect
- `ChatChoices.tsx`: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Lucide –∏–∫–æ–Ω–æ–∫

**–°–º.**: [VOICE_RECORDING.md#–∏—Å—Ç–æ—Ä–∏—è-–∏–∑–º–µ–Ω–µ–Ω–∏–π](VOICE_RECORDING.md#–∏—Å—Ç–æ—Ä–∏—è-–∏–∑–º–µ–Ω–µ–Ω–∏–π)

### 2025-10-22: Padding-bottom Fix
**–ü—Ä–æ–±–ª–µ–º–∞**: –°–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–ª–µ–∑–∞–ª–∏ –Ω–∞ glass tab bar –≤–Ω–∏–∑—É

**–†–µ—à–µ–Ω–∏–µ**:
- –£–≤–µ–ª–∏—á–µ–Ω `padding-bottom` –≤ `.historyChatContainer` —Å 8px –¥–æ 16px

**Commit**: `cd8f0b0` - "Add bottom padding to chat container"

### 2024 (—Ä–∞–Ω–µ–µ): –°–æ–∑–¥–∞–Ω–∏–µ DiscoverTabV2
**–ú–æ—Ç–∏–≤–∞—Ü–∏—è**: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–º

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –°–æ–∑–¥–∞–Ω `ChatManager` –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
- –°–æ–∑–¥–∞–Ω `useChatScroll` hook –¥–ª—è –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞
- –í—ã–Ω–µ—Å–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ planet dialogue –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è reveal scroll –º–µ—Ö–∞–Ω–∏–∑–º–∞

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### ChatManager
**–§–∞–π–ª**: [src/components/chat/ChatManager.tsx](src/components/chat/ChatManager.tsx)

**–†–æ–ª—å**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–º (messages, typing, choices, scroll)

**API**: –°–º. [Props & API](#props--api)

### ChatChoices
**–§–∞–π–ª**: [src/components/chat/ChatChoices.tsx](src/components/chat/ChatChoices.tsx)

**–†–æ–ª—å**: –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ + –∫–Ω–æ–ø–∫–∞ "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"

**Props**:
```typescript
{
  options: HistoryStoryOption[];
  onOptionSelect: (option) => void;
  onCustomOptionClick: () => void;
  customOption?: HistoryStoryOption;
  customOptionStatus?: CustomOptionStatus;
  recordingLevel?: number;
  visibleCount: number;
  hiding: boolean;
  disabled: boolean;
  showCustomButton?: boolean;
}
```

### useChatScroll
**–§–∞–π–ª**: [src/components/chat/useChatScroll.ts](src/components/chat/useChatScroll.ts)

**–†–æ–ª—å**: Auto-scroll –ª–æ–≥–∏–∫–∞ –¥–ª—è —á–∞—Ç–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```typescript
const scrollManager = useChatScroll({
  messagesContainerRef,
  messages,
  phase,
  isActive,
});
```

---

## Troubleshooting

### –ö–Ω–æ–ø–∫–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞**: `currentChoicesRef` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ state

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `setHasChoices(true)` –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ re-render

### Reveal scroll –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `container.scrollTo()` –≤–º–µ—Å—Ç–æ `window.scrollTo()`

**–†–µ—à–µ–Ω–∏–µ**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `window.scrollTo()`

### –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª voice button
**–ü—Ä–∏—á–∏–Ω–∞**: useEffect —Å `setChoices()` –Ω–∞ –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ state

**–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ state —á–µ—Ä–µ–∑ props –≤ ChatManager

**–°–º.**: [VOICE_RECORDING.md#–∏–∑–≤–µ—Å—Ç–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-–∏-—Ä–µ—à–µ–Ω–∏—è](VOICE_RECORDING.md#–∏–∑–≤–µ—Å—Ç–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-–∏-—Ä–µ—à–µ–Ω–∏—è)

### Planet dialogue –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞**: `personalizedPlanetMessages` –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç—ã–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
```typescript
console.log('Personalized messages:', personalizedPlanetMessages);
console.log('Loading:', isLoadingPersonalizedMessages);
```

**–†–µ—à–µ–Ω–∏–µ**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

### AI generation –∑–∞–≤–∏—Å–∞–µ—Ç
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç API –∫–ª—é—á–µ–π –∏–ª–∏ network –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
```typescript
console.log('Has credentials:', hasAiCredentials);
console.log('Claude key:', effectiveClaudeKey ? 'present' : 'missing');
console.log('OpenAI key:', effectiveOpenAIKey ? 'present' : 'missing');
```

**–†–µ—à–µ–Ω–∏–µ**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á–∏ –≤ settings

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –£—Ç–∏–ª–∏—Ç—ã

- [src/utils/historyStory.ts](src/utils/historyStory.ts) - AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–π
- [src/utils/planetMessages.ts](src/utils/planetMessages.ts) - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–∞—É–∑ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ –ø–ª–∞–Ω–µ—Ç
- [src/utils/audioTranscription.ts](src/utils/audioTranscription.ts) - Whisper —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
- [src/utils/psychContractHistory.ts](src/utils/psychContractHistory.ts) - –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

### –î–∞–Ω–Ω—ã–µ

- [src/data/psychologicalContracts.ts](src/data/psychologicalContracts.ts) - –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

### –°—Ç–∏–ª–∏

- [src/components/NastiaApp.module.css](src/components/NastiaApp.module.css) - –í—Å–µ —Å—Ç–∏–ª–∏ –¥–ª—è DiscoverTab

---

**–ê–≤—Ç–æ—Ä**: Claude Code
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-10-22
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 1.0
