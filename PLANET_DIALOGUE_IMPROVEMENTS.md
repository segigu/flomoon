# Улучшение диалога планет: привязка к натальной карте

**Дата**: 16 октября 2025
**Файл**: [src/utils/planetMessages.ts](src/utils/planetMessages.ts)

## Что изменилось

Обновлён промпт для функции `generatePersonalizedPlanetMessages()`, которая генерирует диалог планет перед интерактивной историей.

### Проблема старого промпта

1. **Нет привязки к натальной карте**: Планеты обсуждали "какую историю придумать", но не использовали конкретные аспекты из карты
2. **Поверхностные темы**: Характеры планет были описаны общими словами
3. **Нет контекста напряжений**: Диалог не учитывал реальные квадраты и оппозиции
4. **Нет финального осмысления**: Планеты спорили, но не делали выводов о паттернах поведения

### Решение

#### 1. Добавлен астрологический контекст

Промпт теперь включает:
- **Натальные данные**: дата, время, место рождения
- **Планеты в знаках**: позиции всех планет с их темами
- **Ключевые напряжения**: квадраты и оппозиции (до 3 штук)
- **Ресурсы**: трины и секстили (до 3 штук)

```typescript
const hardAspectsText = NASTIA_CHART_ANALYSIS.hardAspects.slice(0, 3).join('\n');
const softAspectsText = NASTIA_CHART_ANALYSIS.softAspects.slice(0, 3).join('\n');
```

#### 2. Новая задача для планет

Планеты теперь:
- **Ссылаются на конкретные аспекты**: "У неё Луна квадрат Сатурн — боится показать слабость"
- **Объясняют проявление**: Каждая планета говорит, КАК её влияние работает через натальные аспекты
- **Предлагают сценарии**: Конкретные ситуации, которые покажут эти паттерны в действии
- **Спорят о приоритетах**: Какой паттерн важнее проработать сейчас
- **Делают вывод**: Приходят к заключению о главном внутреннем конфликте

#### 3. Обновлённый пример диалога

Старый подход:
```
Луна: "Что сегодня для Насти придумаем?"
Плутон: "У меня идейка тёмненькая про её скрытые страхи..."
Венера: "Плутон, хватит пугать! Давай про отношения лучше."
```

Новый подход:
```
Луна: "Так, коллеги, собрались? Разбираем карту Насти?"
Сатурн: "Смотрю тут — у неё Луна квадрат Сатурн. Эмоции придавлены страхом."
Луна: "Да, она боится показать слабость. Всё в себе держит."
Плутон: "А у меня с Венерой оппозиция! Отношения — это контроль или хаос для неё."
Венера: "Плутон, не драматизируй! Она просто боится потерять себя в близости."
```

#### 4. Обязательный финал

Последние 3-5 фраз теперь ОБЯЗАТЕЛЬНО содержат:
- Какой **главный паттерн** из натальной карты проявляется в жизни?
- Какая **конкретная ситуация** может помочь это увидеть?
- Какой **выбор** нужен для проработки паттерна?

Пример финала:
```
Юпитер: "Итак, выводы. Главный паттерн?"
Сатурн: "Страх быть уязвимой. Луна-Сатурн квадрат — основа."
Луна: "Плюс Венера-Плутон — страх потерять контроль в отношениях."
Хирон: "Рана в уязвимости. Нужна ситуация, где выбор неизбежен."
Венера: "Предлагаю: конфликт в отношениях, где надо открыться."
Марс: "Или выбор действия, где ошибка = уязвимость."
Плутон: "Главное — без выхода. Пусть встретится с собой."
Юпитер: "Решили: ситуация про уязвимость. Выбор — открыться или спрятаться."
Меркурий: "Записываю. История готова."
```

#### 5. Обновлён system prompt

Старый:
```
Создаёшь живые диалоги планет с разными характерами. JSON только.
```

Новый:
```
Создаёшь астрологический диалог планет, которые обсуждают натальную карту конкретного человека.
Они ссылаются на реальные аспекты из карты и делают практические выводы о паттернах поведения.
JSON только.
```

## Преимущества нового подхода

1. **Глубже персонализация**: Диалог привязан к РЕАЛЬНЫМ аспектам натальной карты, а не к общим характерам планет
2. **Конкретика**: Планеты говорят не просто "я про любовь", а "у неё Венера в оппозиции к Плутону — она боится контроля в отношениях"
3. **Структура конфликта**: Напряжённые аспекты дают ПРИЧИНУ для внутренних противоречий
4. **Осмысленный финал**: Планеты не просто спорят, а приходят к выводу, который можно использовать для построения истории
5. **Астрологическая точность**: Интерпретация опирается на конкретные данные карты, а не на общие астрологические темы

## Технические детали

### Изменения в коде

1. **Добавлены переменные для аспектов** (строки 170-172):
```typescript
const hardAspectsText = NASTIA_CHART_ANALYSIS.hardAspects.slice(0, 3).join('\n');
const softAspectsText = NASTIA_CHART_ANALYSIS.softAspects.slice(0, 3).join('\n');
```

2. **Обновлён промпт** (строки 174-255):
   - Добавлен раздел "АСТРОЛОГИЧЕСКИЙ КОНТЕКСТ"
   - Добавлен раздел "КЛЮЧЕВЫЕ НАПРЯЖЕНИЯ"
   - Добавлен раздел "РЕСУРСЫ"
   - Обновлён раздел "ЗАДАЧА ПЛАНЕТ"
   - Расширен пример диалога
   - Добавлен обязательный раздел "ФИНАЛ ДИАЛОГА"

3. **Обновлён system prompt** (строка 261):
   - Более конкретное описание задачи
   - Упор на реальные аспекты и практические выводы

### Параметры AI

- **Temperature**: 0.9 (высокая креативность для диалога)
- **MaxTokens**: 2500 (достаточно для 25-30 фраз)
- **Модель**: Claude Haiku 4.5 (по умолчанию из aiClient)

## Тестирование

Для проверки работы:
1. Открыть приложение
2. Перейти на вкладку "История"
3. Дождаться загрузки диалога планет
4. Проверить, что планеты:
   - Упоминают конкретные аспекты из карты
   - Делают выводы о паттернах поведения
   - Предлагают конкретные сценарии

## Дальнейшие улучшения

Возможные направления:
1. Использовать финальный вывод планет для более точного выбора психологического контракта
2. Передавать выводы планет в промпт генерации истории
3. Добавить анализ транзитов для учёта текущих астрологических влияний
4. Создать систему кэширования выводов планет для повторного использования

## Связанные файлы

- [src/utils/astro.ts](src/utils/astro.ts) - функции астрологических расчётов
- [src/utils/historyStory.ts](src/utils/historyStory.ts) - генерация интерактивных историй
- [src/data/psychologicalContracts.ts](src/data/psychologicalContracts.ts) - психологические контракты для историй
- [src/components/ModernNastiaApp.tsx](src/components/ModernNastiaApp.tsx) - основной компонент с отображением диалога
