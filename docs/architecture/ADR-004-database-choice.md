# ADR-004: Выбор базы данных (Supabase)

**Дата:** 2025-10-26
**Статус:** Принято
**Авторы:** Агент планирования + критический анализ

---

## Контекст

Nastia Calendar изначально был **личным приложением для 1 пользователя** (Настя). Данные хранились в localStorage + синхронизация через GitHub API (в приватный репозиторий nastia-data).

**Изменение концепции:** Проект становится **публичным многопользовательским приложением**.

**Чувствительные данные:**
- Менструальные циклы (даты, длительность, симптомы)
- Настроение по дням
- Психологические паттерны (Фаза 3)
- Выборы в интерактивных историях

**Требования:**
1. Мультипользовательность (авторизация, изоляция данных)
2. Privacy & Security (RLS, шифрование, GDPR compliance)
3. Scalability (поддержка 100+ пользователей)
4. Offline-first (опционально - можно отложить)
5. Стоимость (минимальная для MVP)

---

## Проблема

localStorage + GitHub sync **не поддерживает многопользовательский режим**:
- Нет авторизации (все данные доступны любому, кто открыл приложение)
- Нет изоляции данных (все пользователи видят одни и те же данные)
- GitHub sync не масштабируется (конфликты при одновременной записи)

**Нужна база данных** с поддержкой:
- Auth (Email + Password, OAuth)
- Row Level Security (user A не видит данные user B)
- Structured data (циклы, даты, JSONB для сложных структур)

---

## Рассмотренные варианты

### Вариант A: Supabase

**Описание:** Managed PostgreSQL + Auth + RLS + Edge Functions. Open-source (можно self-host при необходимости).

**Плюсы:**
- ✅ Auth из коробки (Email, OAuth, Magic Links)
- ✅ Row Level Security (PostgreSQL RLS) - лучшая защита для чувствительных данных
- ✅ PostgreSQL - SQL база, отлично подходит для structured data (циклы, даты)
- ✅ Realtime subscriptions (синхронизация между устройствами)
- ✅ Edge Functions (serverless логика без отдельного backend)
- ✅ Free tier достаточен для MVP (500MB база, 5GB bandwidth, 50k MAU)
- ✅ Хорошая документация и активное community
- ✅ Open-source (можно self-host если захочется)

**Минусы:**
- ⚠️ Vendor lock-in (миграция на другую БД сложная)
- ⚠️ Free tier ограничен (2 проекта, проекты засыпают после недели неактивности)
- ⚠️ Данные на сервере Supabase (не self-hosted, но Supabase сертифицирован SOC 2, ISO 27001)

**Стоимость:**
- Free: $0/месяц (500MB база, 5GB bandwidth, 50k MAU) - достаточно для MVP
- Pro: $25/месяц (8GB база, 250GB bandwidth, без засыпания проектов) - когда вырастем

**Время реализации:** 40-50 часов (8-10 дней)

---

### Вариант B: Firebase

**Описание:** Google managed backend (Firestore NoSQL + Auth + Functions + Hosting).

**Плюсы:**
- ✅ Auth из коробки
- ✅ Firestore (NoSQL) - простая для некоторых use cases
- ✅ Firebase Cloud Functions
- ✅ Firebase Hosting + CDN
- ✅ Хорошая интеграция с Google Services

**Минусы:**
- ❌ Firestore Security Rules сложнее чем PostgreSQL RLS
- ❌ NoSQL (Firestore) vs SQL (PostgreSQL) - для нашего случая SQL лучше (циклы, даты, join'ы)
- ❌ Более дорогой scaling (платишь за чтение/запись)
- ❌ Vendor lock-in (миграция с Firestore сложная)

**Стоимость:**
- Free: Spark plan (1GB storage, 10GB/month transfer, 50k reads/day)
- Paid: Blaze (pay-as-you-go, дороже чем Supabase при росте)

**Время реализации:** 45-55 часов

**Почему НЕ выбран:** RLS в Supabase намного лучше для защиты чувствительных данных. PostgreSQL удобнее для structured data (циклы с датами, join таблиц).

---

### Вариант C: Self-hosted PostgreSQL + Auth0

**Описание:** Свой VPS (Digital Ocean, AWS) + PostgreSQL + Auth0 (managed auth) + nginx.

**Плюсы:**
- ✅ Полный контроль (свой сервер, свои данные)
- ✅ PostgreSQL мощнее (любые расширения, функции)
- ✅ Auth0 - профессиональная авторизация (OAuth, MFA, и т.д.)
- ✅ Нет vendor lock-in (можешь мигрировать куда угодно)

**Минусы:**
- ❌ Нужно настраивать VPS (Digital Ocean, AWS)
- ❌ Нужно настраивать PostgreSQL, nginx, SSL, backup, monitoring
- ❌ Нужно обновлять и патчить сервер (security updates)
- ❌ Auth0 платный ($23/месяц для production, free только до 7k MAU)
- ❌ Намного больше времени (~2-3 недели вместо 8-10 дней)
- ❌ Ongoing maintenance (backup, monitoring, scaling)

**Стоимость:**
- VPS: $5-10/месяц (DigitalOcean Droplet)
- Auth0: $0 (до 7k MAU) → $23/месяц (production)
- **Итого:** $5-33/месяц + твоё время на настройку

**Время реализации:** 80-120 часов (2-3 недели)

**Почему НЕ выбран:** Оверкилл для MVP. Supabase даёт те же возможности без настройки инфраструктуры. Можно мигрировать на self-hosted позже если понадобится (Supabase open-source).

---

### Вариант D: Остаться на localStorage + GitHub sync

**Описание:** Продолжать использовать текущее хранилище (localStorage + синхронизация через GitHub API).

**Плюсы:**
- ✅ Уже работает (0 времени на миграцию)
- ✅ $0 стоимость навсегда
- ✅ Полный контроль над данными (на устройстве пользователя)
- ✅ Offline-first из коробки

**Минусы:**
- ❌ **НЕ поддерживает многопользовательский режим** (критично!)
- ❌ Нельзя дать доступ друзьям/другим пользователям
- ❌ Нет авторизации
- ❌ Нет публичного приложения
- ❌ Блокирует Фазу 3 (AI-агенты не могут работать на сервере)

**Время реализации:** 0 часов (ничего не делаем)

**Почему НЕ выбран:** Не соответствует новой цели проекта - создать публичное многопользовательское приложение.

---

## Решение

**Выбран Вариант A: Supabase**

**Обоснование:**
1. **RLS из коробки** - лучшая защита чувствительных данных для многопользовательского приложения
2. **PostgreSQL** - SQL база идеальна для structured data (циклы, даты, корреляции)
3. **Auth из коробки** - Email + Password + OAuth без написания backend
4. **Free tier достаточен для MVP** - 500MB база, 5GB bandwidth, 50k MAU
5. **Быстрая разработка** - 8-10 дней вместо 2-3 недель (self-hosted)
6. **Open-source** - можно self-host если захочется в будущем
7. **SOC 2 / ISO 27001** - серьёзная сертификация для чувствительных данных

---

## Последствия

### Позитивные

- ✅ **Мультипользовательность** - любой может зарегистрироваться и использовать приложение
- ✅ **Privacy & Security** - RLS гарантирует, что user A не видит данные user B
- ✅ **Фаза 3 (AI-агенты)** может работать на сервере (анализировать данные без отправки на клиент)
- ✅ **Scalability** - Supabase автоматически масштабируется (до определённого предела)
- ✅ **Realtime sync** - изменения синхронизируются между устройствами автоматически
- ✅ **Managed infrastructure** - не нужно настраивать VPS, backup, monitoring

### Негативные

- ⚠️ **Vendor lock-in** - миграция на другую БД сложная (но Supabase open-source, можно self-host)
- ⚠️ **Free tier limitations** - проекты засыпают после недели неактивности (cold start ~1-2 сек)
- ⚠️ **Данные на сервере Supabase** - не self-hosted (но Supabase сертифицирован)
- ⚠️ **Стоимость при росте** - $25/месяц для Pro (но только когда вырастем >500MB или >5GB bandwidth)
- ⚠️ **Удаление GitHub sync** - старая синхронизация больше не работает (но она не нужна)

### Риски

1. **Потеря данных при миграции** - митигация: backup localStorage, dry-run миграции
2. **Утечка данных через RLS** - митигация: тщательное тестирование policies
3. **Supabase недоступен** - митигация: fallback UI, логирование ошибок
4. **Service Role Key утечёт** - митигация: НИКОГДА не использовать на клиенте, .env.local в .gitignore

---

## Альтернативы для будущего

Если в будущем понадобится изменить решение:

1. **Self-host Supabase** (если нужен полный контроль) - Supabase open-source, можно развернуть на своём VPS
2. **Мигрировать на Firebase** (если нужна интеграция с Google Services) - ~2-3 недели работы
3. **Мигрировать на self-hosted PostgreSQL** (если нужна кастомизация) - ~1-2 недели работы

**Критерий для пересмотра:**
- Суммарные расходы на Supabase >$100/месяц (unlikely в ближайшие 2-3 года)
- Нужна специфичная функциональность PostgreSQL, которой нет в Supabase
- Требование хранить данные on-premise (регуляторные причины)

---

## Backend архитектура: Тонкий клиент + Edge Functions

**Дата решения:** 2025-10-26

**Контекст:** После выбора Supabase возник вопрос о распределении логики между клиентом и сервером.

**Рассмотренные варианты:**

### Вариант A: SPA (вся логика в браузере)
- Браузер: React + TypeScript + cycleUtils + aiClient
- Сервер: только данные (PostgreSQL)
- **Минусы:** API ключи Claude/OpenAI в .env клиента (риск утечки), нет контроля стоимости

### Вариант B: Тонкий клиент (выбран)
- Браузер: только UI (React компоненты + fetch)
- Сервер: вся бизнес-логика (Edge Functions) + PostgreSQL
- **Плюсы:**
  - 🔒 API ключи на сервере (Supabase Secrets)
  - 💰 Контроль стоимости AI (rate limiting на сервере)
  - 📊 Централизованная логика (обновления без перезагрузки клиента)
  - ⚡ Тяжёлые вычисления на сервере
- **Минусы:** Нет offline режима (это ok, текущая GitHub sync тоже требует интернет)

**Решение:** Вариант B - тонкий клиент.

**Реализация:**
- Миграция `cycleUtils.ts` → Edge Function `/supabase/functions/calculate-cycle`
- Миграция `aiClient.ts` → Edge Function `/supabase/functions/generate-ai-content`
- Создание API слоя `/src/utils/api.ts` на клиенте
- Rate limiting: 10 AI запросов/час на пользователя

**Стоимость Edge Functions (Supabase):**
- Free: 500k invocations/month (~16k/день)
- Для 100 пользователей × 10 операций/день = 1k/день ✅
- Для 1000 пользователей = 10k/день ✅

---

## Реализация

**План:** См. [PHASE_2_DATABASE_DETAILED_PLAN.md](../roadmap/PHASE_2_DATABASE_DETAILED_PLAN.md)

**Время:** 60-80 часов (12-16 дней)

**Основные задачи:**
1. Настройка Supabase (таблицы, RLS, auth)
2. Авторизация в UI (login, signup, logout)
3. Миграция storage.ts → storageSupabase.ts
4. Удаление старой GitHub sync
5. Privacy & Security (Privacy Policy, Delete Account, RLS тесты)
6. Тестирование и документация
7. **Миграция логики на Edge Functions (20-30 часов)** ← НОВОЕ

---

## Ссылки

- [Supabase Docs](https://supabase.com/docs)
- [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [PHASE_2_DATABASE_DETAILED_PLAN.md](../roadmap/PHASE_2_DATABASE_DETAILED_PLAN.md)

---

**Последнее обновление:** 2025-10-26
