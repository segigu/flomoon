# ADR-002: Трёхуровневая система AI-агентов

**Дата:** 2025-10-26
**Статус:** ✅ Принято
**Автор:** Команда Nastia Calendar

---

## Контекст

Нам нужно обрабатывать данные пользователя (выборы в историях, заметки о днях цикла, корреляции с астрологией) через AI для создания психологического портрета.

**Проблема:** Стоимость запросов к Claude Sonnet 4.5 делает наивный подход слишком дорогим.

**Наивный подход (отправлять всё в Sonnet):**
```
Завершение 1 истории:
- Анализ 7 выборов: 7 * 2000 токенов = 14,000 токенов
- Анализ паттернов: 5000 токенов (вся история)
- Генерация следующего контракта: 8000 токенов (вся история)
ИТОГО: ~27,000 токенов (~$0.27 с Sonnet)

10 историй в месяц: ~$2.70 на пользователя
```

**Недопустимо дорого** для масштабирования (100+ пользователей = $270/месяц).

---

## Решение

Использовать **трёхуровневую систему агентов** с разделением по сложности задач и моделям AI:

### Tier 1: Детекторы (Haiku 4.5)
**Задача:** Быстрая классификация микроданных (детерминированные задачи)
**Стоимость:** ~$0.0001-0.0003 за запрос

**Агенты:**
- `TrapDetectorAgent` - классификация выборов по категориям психологических ловушек
- `BatchTrapDetectorAgent` - batch-версия (7 выборов за раз)
- `ThemeExtractorAgent` - извлечение тем из заметок пользователя

**Характеристики:**
- Температура: 0.2-0.3 (детерминированность)
- Max tokens: 100-150
- Формат вывода: JSON
- Batch processing для экономии overhead

---

### Tier 2: Аналитики (Haiku 4.5)
**Задача:** Анализ агрегированных данных (не сырые данные!)
**Стоимость:** ~$0.0005-0.001 за запрос

**Агенты:**
- `PatternAnalyzerAgent` - анализ паттернов поведения из статистики
- `CorrelationAnalyzerAgent` - поиск корреляций цикл/астро/настроение

**Характеристики:**
- Температура: 0.5 (баланс детерминизма и креативности)
- Max tokens: 300-600
- Input: агрегированная статистика (не сырые данные)
- Запуск: раз в неделю или каждые 5 историй (не после каждой)

---

### Tier 3: Креативщики (Sonnet 4.5)
**Задача:** Генерация креативного контента на основе выжимок
**Стоимость:** ~$0.015-0.030 за запрос

**Агенты:**
- `ContractPersonalizerAgent` - генерация персонализированных психологических контрактов
- `InsightGeneratorAgent` - генерация человекочитаемых инсайтов для UI

**Характеристики:**
- Температура: 0.6-0.7 (креативность)
- Max tokens: 1500-2000
- Input: выжимки от Tier 2 агентов (не сырые данные!)
- Prompt caching для базового контекста (натальная карта, библиотеки)

---

## Обоснование

### Почему 3 уровня?

1. **Экономия токенов:**
   - Tier 1: дешёвая модель для простых задач → 90% экономии
   - Tier 2: дешёвая модель для аналитики → 80% экономии
   - Tier 3: дорогая модель только для креатива → необходимое качество

2. **Скорость:**
   - Haiku быстрее Sonnet в 3-5 раз
   - Критично для UX (пользователь не ждёт долго)

3. **Масштабируемость:**
   - Легко добавлять новых агентов в любой Tier
   - Можно параллелить Tier 1 агентов (batch processing)

4. **Качество:**
   - Дорогая модель (Sonnet) только там, где нужна креативность
   - Простые задачи не требуют сложной модели

---

### Почему Haiku для Tier 1-2?

**Плюсы:**
- В 20-30 раз дешевле Sonnet
- Достаточно для классификации и анализа статистики
- Быстрый ответ (<2 секунды)

**Минусы:**
- Хуже в креативных задачах
- **Митигация:** Используем Sonnet для Tier 3

---

### Почему Sonnet для Tier 3?

**Плюсы:**
- Высокое качество генерации контента
- Понимает нюансы психологии и астрологии
- Может работать с контекстом (prompt caching)

**Минусы:**
- Дорого
- **Митигация:** Отправляем только выжимки (не сырые данные)

---

## Экономика токенов

### Без оптимизации (все в Sonnet):
```
Завершение 1 истории: ~27,000 токенов (~$0.27)
```

### С 3-уровневой системой:
```
Tier 1 (BatchTrapDetector):   ~1,050 токенов ($0.0001)
Tier 2 (PatternAnalyzer):       ~600 токенов ($0.0006)
Tier 3 (ContractPersonalizer): ~2,000 токенов ($0.01 с caching)
---
ИТОГО: ~3,650 токенов (~$0.011)

ЭКОНОМИЯ: 24x раз! (27,000 → 3,650)
```

### На месяц (10 историй + 4 отчёта):
```
10 историй * $0.011 = $0.11
4 еженедельных отчёта * $0.008 = $0.032
---
ИТОГО: ~$0.15 на пользователя/месяц

100 пользователей: ~$15/месяц (vs $270 без оптимизации)
```

---

## Альтернативы

### Альтернатива 1: Всё через Sonnet
Использовать Sonnet для всех задач.

**Плюсы:**
- Простота реализации (один тип агента)
- Максимальное качество

**Минусы:**
- Дорого ($0.27 за историю)
- Медленно (Sonnet медленнее Haiku)
- **Не выбрано:** Недопустимо дорого для масштабирования

---

### Альтернатива 2: Всё через Haiku
Использовать Haiku для всех задач, включая генерацию контента.

**Плюсы:**
- Дешево ($0.002 за историю)
- Быстро

**Минусы:**
- Хуже качество креатива (контракты, инсайты)
- Меньше понимания нюансов психологии
- **Не выбрано:** Качество важнее экономии для Tier 3

---

### Альтернатива 3: Только локальные эвристики (без AI)
Использовать регулярные выражения и статистику без AI.

**Плюсы:**
- Бесплатно
- Мгновенно

**Минусы:**
- Нет персонализации
- Нет понимания контекста
- Хрупкие правила (легко ломаются)
- **Не выбрано:** Не достигает цели (психологический профайлинг)

---

## Последствия

### Положительные
- ✅ Экономия 24x на токенах
- ✅ Быстрый отклик (Tier 1-2 на Haiku)
- ✅ Высокое качество креатива (Tier 3 на Sonnet)
- ✅ Масштабируемость (легко добавлять агентов)

### Отрицательные
- ⚠️ Усложнение архитектуры (3 типа агентов вместо 1)
- ⚠️ Нужна инфраструктура (BaseAgent, batch processing)
- ⚠️ Нужна логика инкрементальных обновлений

### Митигация рисков
- Создать базовый класс `BaseAgent` для переиспользования кода
- Автоматический выбор модели по конфигурации (Haiku/Sonnet)
- Comprehensive тесты для каждого агента
- Fallback на локальные эвристики при ошибках API

---

## Связанные документы

- [PHASE_2_AI_AGENTS.md](../roadmap/PHASE_2_AI_AGENTS.md) - детальный план реализации
- [ADR-003-prompt-caching.md](./ADR-003-prompt-caching.md) - стратегия кэширования
- [AGENT_PROMPTS.md](./AGENT_PROMPTS.md) - промпты всех агентов

---

## Пример workflow

```typescript
// Пользователь завершил историю
async function handleStoryComplete(story: StoryAnalysis) {
  // 1. Tier 1: Классификация выборов (Haiku, batch)
  const detector = new BatchTrapDetectorAgent();
  const categories = await detector.execute(story.choices); // ~$0.0001

  // 2. Обновить локальную статистику (БЕЗ AI)
  updatePatternStatsLocally(story);

  // 3. Tier 2: Анализ (только если накопилось 5 историй)
  if (shouldRunFullAnalysis()) {
    const analyzer = new PatternAnalyzerAgent();
    const insights = await analyzer.execute(getCurrentStats()); // ~$0.001
    saveInsights(insights);
  }

  // 4. Tier 3: Генерация следующего контракта (Sonnet)
  const personalizer = new ContractPersonalizerAgent();
  const contract = await personalizer.execute({
    insights: loadCachedInsights(), // От Tier 2
    astroVulnerabilities: getAstroVulnerabilities(),
  }); // ~$0.01 с caching

  return contract;
}
```

---

**Создано:** 2025-10-26
**Обновлено:** 2025-10-26
