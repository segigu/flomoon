# ADR-001: Универсальная структура профиля пользователя

**Дата:** 2025-10-26
**Статус:** ✅ Принято
**Автор:** Команда Nastia Calendar

---

## Контекст

Текущая версия приложения хардкодит данные конкретного пользователя (Настя) по всему коду:
- Имя в промптах: "Настя"
- Натальная карта: хардкоженная константа `NASTIA_PROFILE`
- Контекст общения: "черный юмор", "усталость", уровень мата
- Партнёр: хардкожен "Серёжа" (13 декабря 1979)

**Проблемы:**
1. Невозможно добавить других пользователей без рефакторинга всего кода
2. Данные пользователя разбросаны по файлам (astroProfiles.ts, horoscope.ts, historyStory.ts)
3. Нет единого источника правды для профиля пользователя
4. Сложно тестировать с разными профилями

**Будущие требования:**
- Поддержка авторизации (пользователь вводит свои данные рождения)
- Привязка партнёра для синастрии
- Несколько пользователей в системе

---

## Решение

Создать универсальную структуру `UserProfile` с интерфейсом, который описывает все данные пользователя:

```typescript
export interface UserProfile {
  id: string;                    // Уникальный идентификатор
  name: string;                  // Полное имя
  displayName: string;           // Для UI ("Настя", "Твой")
  astroProfileId: AstroProfile['id']; // Ссылка на натальную карту

  relationshipPartners?: {       // Партнёр для синастрии
    profileId: AstroProfile['id'];
    relationshipType: 'romantic' | 'family' | 'friend';
  }[];

  context: {                     // Контекст общения
    location: string;            // "Европа"
    personalityTraits: string[]; // ["самоирония", "черный юмор"]
    communicationStyle: 'sarcastic' | 'supportive' | 'direct' | 'gentle';
    profanityLevel: 'none' | 'light' | 'medium' | 'heavy';
  };

  preferences: {                 // Настройки пользователя
    horoscopeStyle: 'weekly' | 'daily' | 'both';
    storyComplexity: 'simple' | 'moderate' | 'deep';
    notificationsEnabled: boolean;
  };
}
```

**Реализация:**
1. Создать файл `src/data/userProfile.ts` с интерфейсом и константами
2. Экспортировать константу `USER_PROFILES` (словарь всех пользователей)
3. Экспортировать `CURRENT_USER_ID = 'nastia'` (пока константа, потом из localStorage)
4. Экспортировать функцию `getCurrentUser()` → `UserProfile`
5. Заменить все хардкоженные упоминания "Настя" на `getCurrentUser().displayName`

---

## Обоснование

### Почему универсальная структура?
- **Масштабируемость:** Легко добавить новых пользователей
- **Тестируемость:** Можно тестировать с разными профилями
- **Maintainability:** Один источник правды для данных пользователя
- **Гибкость:** Легко добавлять новые поля в будущем

### Почему `getCurrentUser()` вместо глобальной переменной?
- Позволяет переключать пользователей динамически (в будущем)
- Упрощает тестирование (можно мокать функцию)
- Безопасность типов (TypeScript гарантирует, что профиль существует)

### Почему `profanityLevel` в профиле?
- Разные пользователи имеют разные предпочтения по стилю общения
- AI должен адаптироваться к пользователю (не все любят мат)
- Легко настраивается через UI

---

## Альтернативы

### Альтернатива 1: Context Provider в React
Использовать React Context для хранения текущего пользователя.

**Плюсы:**
- Стандартный подход в React
- Автоматическое обновление компонентов

**Минусы:**
- Усложняет код
- Нужен Provider на верхнем уровне
- Утилиты вне React (astro.ts, horoscope.ts) не могут использовать Context
- **Не выбран:** Слишком сложно для текущего этапа (один пользователь)

---

### Альтернатива 2: База данных сразу
Хранить профили в БД (Supabase/Firebase), загружать при авторизации.

**Плюсы:**
- Готово к продакшену
- Безопасность данных

**Минусы:**
- Overengineering для MVP
- Усложняет разработку
- Нужна авторизация
- **Не выбран:** Сделаем позже, когда будет мультипользовательность

---

### Альтернатива 3: Оставить хардкод
Не делать универсализацию, оставить как есть.

**Плюсы:**
- Не нужно рефакторить

**Минусы:**
- Блокирует мультипользовательность
- Невозможно тестировать с разными профилями
- Tech debt накапливается
- **Не выбран:** Блокирует будущие фичи

---

## Последствия

### Положительные
- ✅ Готовность к мультипользовательности
- ✅ Легко тестировать с разными профилями
- ✅ Один источник правды для данных пользователя
- ✅ Упрощает добавление новых полей

### Отрицательные
- ⚠️ Нужно рефакторить весь код (horoscope.ts, historyStory.ts, компоненты)
- ⚠️ Занимает время (~3-4 дня Фаза 1)
- ⚠️ Риск регрессий (нужно тщательно тестировать)

### Митигация рисков
- Создать comprehensive тесты для новых утилит
- Обновить существующие тесты
- Проверить обратную совместимость с localStorage
- Постепенный рефакторинг (по одному файлу за раз)

---

## Связанные документы

- [PHASE_1_FOUNDATION.md](../roadmap/PHASE_1_FOUNDATION.md) - детальный план реализации
- [MASTER_PLAN.md](../MASTER_PLAN.md) - общий план проекта

---

## Пример использования

### До (хардкод):
```typescript
// horoscope.ts
const context = `
Настя — пользователь, живет в Европе. Устала, но держится
за счет самоиронии и черного юмора.

Партнер — Сергей (13 декабря 1979).
`;
```

### После (универсально):
```typescript
// horoscope.ts
import { getCurrentUser } from '@/data/userProfile';

const user = getCurrentUser();
const partner = user.relationshipPartners?.[0];

const context = `
${user.displayName} — пользователь, живет в ${user.context.location}.
${user.context.personalityTraits.join(', ')}.

${partner ? `Партнер — ${getAstroProfile(partner.profileId).name}.` : ''}
`;
```

---

**Создано:** 2025-10-26
**Обновлено:** 2025-10-26
